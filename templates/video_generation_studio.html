{% extends "base.html" %}

{% block extra_css %}
<style>
:root {
    --studio-bg-primary: #1a1d23;
    --studio-bg-secondary: #252932;
    --studio-bg-tertiary: #2f353f;
    --studio-accent: #4a9eff;
    --studio-accent-hover: #3d8bdf;
    --studio-success: #22c55e;
    --studio-warning: #f59e0b;
    --studio-danger: #ef4444;
    --studio-text-primary: #ffffff;
    --studio-text-secondary: #a1a8b3;
    --studio-text-muted: #6b7280;
    --studio-border: #374151;
    --studio-border-light: #4b5563;
}

.studio-container {
    background: var(--studio-bg-primary);
    min-height: 100vh;
    color: var(--studio-text-primary);
}

.studio-header {
    background: var(--studio-bg-secondary);
    border-bottom: 1px solid var(--studio-border);
    padding: 1rem 0;
}

.studio-main {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 0;
    min-height: calc(100vh - 80px);
}

.studio-sidebar {
    background: var(--studio-bg-secondary);
    border-right: 1px solid var(--studio-border);
    overflow-y: auto;
    max-height: calc(100vh - 80px);
}

.studio-content {
    background: var(--studio-bg-primary);
    overflow-y: auto;
    max-height: calc(100vh - 80px);
}

.config-section {
    border-bottom: 1px solid var(--studio-border);
    padding: 1.5rem;
}

.config-section:last-child {
    border-bottom: none;
}

.section-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--studio-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-content {
    space: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--studio-text-primary);
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    width: 100%;
    padding: 0.75rem;
    background: var(--studio-bg-tertiary);
    border: 1px solid var(--studio-border);
    border-radius: 6px;
    color: var(--studio-text-primary);
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    outline: none;
    border-color: var(--studio-accent);
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.form-control::placeholder {
    color: var(--studio-text-muted);
}

.range-container {
    position: relative;
}

.range-input {
    width: 100%;
    height: 6px;
    background: var(--studio-bg-tertiary);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
}

.range-input::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--studio-accent);
    border-radius: 50%;
    cursor: pointer;
}

.range-input::-moz-range-thumb {
    width: 18px;
    height: 18px;
    background: var(--studio-accent);
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

.range-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--studio-text-muted);
    margin-top: 0.25rem;
}

.range-value {
    font-size: 0.875rem;
    color: var(--studio-accent);
    font-weight: 600;
    text-align: center;
    margin-top: 0.5rem;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--studio-border);
    transition: 0.3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--studio-accent);
}

input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.radio-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.radio-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.radio-option input[type="radio"] {
    width: 16px;
    height: 16px;
    accent-color: var(--studio-accent);
}

.radio-option label {
    font-size: 0.875rem;
    color: var(--studio-text-primary);
    cursor: pointer;
}

.advanced-toggle {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--studio-border);
}

.toggle-btn {
    background: none;
    border: none;
    color: var(--studio-accent);
    font-size: 0.875rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color 0.2s ease;
}

.toggle-btn:hover {
    color: var(--studio-accent-hover);
}

.advanced-options {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--studio-border);
    display: none;
}

.advanced-options.show {
    display: block;
}

.prompt-section {
    padding: 2rem;
}

.prompt-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.prompt-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--studio-text-primary);
}

.prompt-subtitle {
    color: var(--studio-text-secondary);
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.prompt-textarea {
    width: 100%;
    height: 200px;
    padding: 1rem;
    background: var(--studio-bg-secondary);
    border: 1px solid var(--studio-border);
    border-radius: 8px;
    color: var(--studio-text-primary);
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.875rem;
    resize: vertical;
    min-height: 200px;
}

.prompt-textarea:focus {
    outline: none;
    border-color: var(--studio-accent);
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.btn-studio {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: var(--studio-accent);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: var(--studio-accent-hover);
}

.btn-primary:disabled {
    background: var(--studio-border);
    cursor: not-allowed;
}

.btn-success {
    background: var(--studio-success);
    color: white;
}

.btn-secondary {
    background: var(--studio-bg-tertiary);
    color: var(--studio-text-primary);
    border: 1px solid var(--studio-border);
}

.btn-secondary:hover {
    background: var(--studio-border);
}

.results-section {
    padding: 2rem;
    border-top: 1px solid var(--studio-border);
}

.results-grid {
    display: grid;
    gap: 1rem;
}

.result-item {
    background: var(--studio-bg-secondary);
    border: 1px solid var(--studio-border);
    border-radius: 8px;
    padding: 1rem;
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.result-prompt {
    font-size: 0.875rem;
    color: var(--studio-text-secondary);
    line-height: 1.4;
}

.result-status {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-pending {
    background: var(--studio-bg-tertiary);
    color: var(--studio-text-muted);
}

.status-generating {
    background: rgba(245, 158, 11, 0.2);
    color: var(--studio-warning);
}

.status-completed {
    background: rgba(34, 197, 94, 0.2);
    color: var(--studio-success);
}

.status-failed {
    background: rgba(239, 68, 68, 0.2);
    color: var(--studio-danger);
}

.result-video {
    margin-top: 1rem;
}

.result-video video {
    width: 100%;
    border-radius: 6px;
    background: var(--studio-bg-tertiary);
}

.alert-studio {
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    border-left: 4px solid;
}

.alert-success {
    background: rgba(34, 197, 94, 0.1);
    border-color: var(--studio-success);
    color: var(--studio-success);
}

.alert-danger {
    background: rgba(239, 68, 68, 0.1);
    border-color: var(--studio-danger);
    color: var(--studio-danger);
}

.help-text {
    font-size: 0.75rem;
    color: var(--studio-text-muted);
    margin-top: 0.25rem;
}

.config-summary {
    background: var(--studio-bg-tertiary);
    border: 1px solid var(--studio-border);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.summary-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--studio-text-primary);
    margin-bottom: 0.5rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--studio-text-secondary);
    margin-bottom: 0.25rem;
}

.summary-value {
    color: var(--studio-text-primary);
    font-weight: 500;
}

@media (max-width: 1024px) {
    .studio-main {
        grid-template-columns: 1fr;
    }
    
    .studio-sidebar {
        border-right: none;
        border-bottom: 1px solid var(--studio-border);
        max-height: none;
    }
}

.file-upload-area {
    border: 2px dashed var(--studio-border);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background: var(--studio-bg-tertiary);
    transition: all 0.2s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--studio-accent);
    background: rgba(74, 158, 255, 0.05);
}

.file-upload-area.dragover {
    border-color: var(--studio-accent);
    background: rgba(74, 158, 255, 0.1);
}

.upload-icon {
    font-size: 2rem;
    color: var(--studio-text-muted);
    margin-bottom: 0.5rem;
}

.upload-text {
    color: var(--studio-text-secondary);
    font-size: 0.875rem;
}

.upload-subtext {
    color: var(--studio-text-muted);
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.file-preview {
    background: var(--studio-bg-secondary);
    border: 1px solid var(--studio-border);
    border-radius: 6px;
    padding: 0.75rem;
    margin-top: 1rem;
    display: none;
}

.file-preview.show {
    display: block;
}

.file-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.file-name {
    font-size: 0.875rem;
    color: var(--studio-text-primary);
}

.file-remove {
    background: none;
    border: none;
    color: var(--studio-danger);
    cursor: pointer;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="studio-container">
    <!-- Header -->
    <div class="studio-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="prompt-title mb-0">Video Generation Studio</h1>
                    <div class="prompt-subtitle">Professional VEO3 video generation with full parameter control</div>
                </div>
                <a href="/" class="btn-studio btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="studio-main">
        <!-- Configuration Sidebar -->
        <div class="studio-sidebar">
            <!-- Model Selection -->
            <div class="config-section">
                <div class="section-title">
                    <i class="fas fa-microchip"></i>
                    Model Configuration
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label class="form-label">VEO Model</label>
                        <select id="model" class="form-select">
                            <option value="veo-3.0-fast-generate-001">VEO 3.0 Fast (Recommended)</option>
                            <option value="veo-3.0-generate-001">VEO 3.0 Standard</option>
                            <option value="veo-3.0-generate-preview">VEO 3.0 Preview</option>
                            <option value="veo-3.0-fast-generate-preview">VEO 3.0 Fast Preview</option>
                            <option value="veo-2.0-generate-001">VEO 2.0 (Legacy)</option>
                        </select>
                        <div class="help-text">Choose between speed (fast) and quality (standard)</div>
                    </div>
                </div>
            </div>

            <!-- Video Configuration -->
            <div class="config-section">
                <div class="section-title">
                    <i class="fas fa-video"></i>
                    Video Settings
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label class="form-label">Aspect Ratio</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="aspect_16_9" name="aspect_ratio" value="16:9" checked>
                                <label for="aspect_16_9">16:9 (Landscape)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="aspect_9_16" name="aspect_ratio" value="9:16">
                                <label for="aspect_9_16">9:16 (Portrait)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <div class="range-container">
                            <input type="range" id="duration" class="range-input" min="5" max="8" value="8" step="1">
                            <div class="range-labels">
                                <span>5s</span>
                                <span>8s</span>
                            </div>
                            <div class="range-value" id="duration-value">8 seconds</div>
                        </div>
                    </div>

                    <div class="form-group" id="resolution-group">
                        <label class="form-label">Resolution <span class="help-text">(VEO 3 only)</span></label>
                        <select id="resolution" class="form-select">
                            <option value="">Auto (Default)</option>
                            <option value="720p">720p (HD)</option>
                            <option value="1080p">1080p (Full HD)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Sample Count</label>
                        <div class="range-container">
                            <input type="range" id="sample_count" class="range-input" min="1" max="4" value="1" step="1">
                            <div class="range-labels">
                                <span>1</span>
                                <span>4</span>
                            </div>
                            <div class="range-value" id="sample-count-value">1 video</div>
                        </div>
                        <div class="help-text">Number of video variations to generate</div>
                    </div>
                </div>
            </div>

            <!-- Generation Options -->
            <div class="config-section">
                <div class="section-title">
                    <i class="fas fa-sliders-h"></i>
                    Generation Options
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label class="form-label">Enhance Prompt</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enhance_prompt" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="help-text">AI will enhance and optimize your prompt</div>
                    </div>

                    <div class="form-group" id="audio-group">
                        <label class="form-label">Generate Audio</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="generate_audio">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="help-text">Add synchronized audio to the video</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Person Generation</label>
                        <select id="person_generation" class="form-select">
                            <option value="">Default</option>
                            <option value="allow_adult">Allow Adult Content</option>
                            <option value="dont_allow">Restrict Adult Content</option>
                        </select>
                    </div>
                </div>

                <!-- Advanced Options Toggle -->
                <div class="advanced-toggle">
                    <button type="button" class="toggle-btn" id="advanced-toggle">
                        <i class="fas fa-chevron-down"></i>
                        Advanced Options
                    </button>
                    <div class="advanced-options" id="advanced-options">
                        <div class="form-group">
                            <label class="form-label">Negative Prompt</label>
                            <textarea id="negative_prompt" class="form-control" rows="3" placeholder="Describe what you don't want in the video..."></textarea>
                            <div class="help-text">Specify elements to avoid in generation</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Seed</label>
                            <input type="number" id="seed" class="form-control" placeholder="Random seed for reproducibility">
                            <div class="help-text">Leave empty for random results</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Storage URI</label>
                            <input type="text" id="storage_uri" class="form-control" placeholder="gs://your-bucket/path/">
                            <div class="help-text">Custom GCS storage location</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Input (Advanced) -->
            <div class="config-section">
                <div class="section-title">
                    <i class="fas fa-image"></i>
                    Media Conditioning
                    <span class="help-text" style="font-size: 0.75rem; margin-left: auto;">(Optional)</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label class="form-label">Input Image</label>
                        <div class="file-upload-area" id="image-upload-area">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">Drop image here or click to browse</div>
                            <div class="upload-subtext">PNG, JPG up to 10MB</div>
                        </div>
                        <input type="file" id="image-input" accept="image/*" style="display: none;">
                        <div class="file-preview" id="image-preview">
                            <div class="file-info">
                                <span class="file-name" id="image-name"></span>
                                <button type="button" class="file-remove" onclick="removeImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="help-text">Use image as starting point for video generation</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="studio-content">
            <!-- Prompt Section -->
            <div class="prompt-section">
                <div class="prompt-header">
                    <div>
                        <h2 class="prompt-title">Prompts</h2>
                        <div class="prompt-subtitle">Enter your video generation prompts (one per line or JSON array)</div>
                    </div>
                </div>

                <!-- Configuration Summary -->
                <div class="config-summary">
                    <div class="summary-title">Current Configuration</div>
                    <div class="summary-item">
                        <span>Model:</span>
                        <span class="summary-value" id="summary-model">VEO 3.0 Fast</span>
                    </div>
                    <div class="summary-item">
                        <span>Aspect Ratio:</span>
                        <span class="summary-value" id="summary-aspect">16:9</span>
                    </div>
                    <div class="summary-item">
                        <span>Duration:</span>
                        <span class="summary-value" id="summary-duration">8 seconds</span>
                    </div>
                    <div class="summary-item">
                        <span>Samples:</span>
                        <span class="summary-value" id="summary-samples">1 video</span>
                    </div>
                </div>

                <!-- Alerts -->
                <div id="alert-container"></div>

                <!-- Prompt Input -->
                <textarea id="prompts" class="prompt-textarea" placeholder='Enter prompts (one per line):

A cat playing piano in a jazz bar, cinematic lighting
Slow orbital shot of a futuristic eco city at sunrise
Drone flyover of terraced rice fields with morning mist

Or as JSON array:
["prompt 1", "prompt 2", "prompt 3"]'></textarea>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button type="button" id="validate-btn" class="btn-studio btn-primary">
                        <i class="fas fa-check"></i>
                        Validate Prompts
                    </button>
                    <button type="button" id="generate-btn" class="btn-studio btn-success" disabled>
                        <i class="fas fa-play"></i>
                        Generate Videos
                    </button>
                    <button type="button" id="sample-btn" class="btn-studio btn-secondary">
                        <i class="fas fa-lightbulb"></i>
                        Load Samples
                    </button>
                    <button type="button" id="clear-btn" class="btn-studio btn-secondary">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="results-section" style="display: none;">
                <div class="section-title">
                    <i class="fas fa-film"></i>
                    Generation Results
                </div>
                <div class="results-grid" id="results-grid">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentPrompts = [];
let currentJobId = null;
let validatedConfig = null;

// Initialize the UI
document.addEventListener('DOMContentLoaded', function() {
    initializeControls();
    initializeEventListeners();
    updateConfigSummary();
});

function initializeControls() {
    // Update range value displays
    updateRangeDisplay('duration', 'duration-value', value => `${value} seconds`);
    updateRangeDisplay('sample_count', 'sample-count-value', value => `${value} video${value > 1 ? 's' : ''}`);
    
    // Initialize model-dependent options
    updateModelDependentOptions();
}

function initializeEventListeners() {
    // Model selection change
    document.getElementById('model').addEventListener('change', updateModelDependentOptions);
    
    // Range inputs
    document.getElementById('duration').addEventListener('input', function() {
        updateRangeDisplay('duration', 'duration-value', value => `${value} seconds`);
        updateConfigSummary();
    });
    
    document.getElementById('sample_count').addEventListener('input', function() {
        updateRangeDisplay('sample_count', 'sample-count-value', value => `${value} video${value > 1 ? 's' : ''}`);
        updateConfigSummary();
    });
    
    // Configuration changes
    ['model', 'aspect_ratio', 'resolution', 'enhance_prompt', 'generate_audio', 'person_generation'].forEach(id => {
        const element = document.getElementById(id) || document.querySelector(`input[name="${id}"]`);
        if (element) {
            if (element.type === 'radio') {
                document.querySelectorAll(`input[name="${id}"]`).forEach(radio => {
                    radio.addEventListener('change', updateConfigSummary);
                });
            } else {
                element.addEventListener('change', updateConfigSummary);
            }
        }
    });
    
    // Advanced options toggle
    document.getElementById('advanced-toggle').addEventListener('click', toggleAdvancedOptions);
    
    // File upload
    setupFileUpload();
    
    // Action buttons
    document.getElementById('validate-btn').addEventListener('click', validatePrompts);
    document.getElementById('generate-btn').addEventListener('click', generateVideos);
    document.getElementById('sample-btn').addEventListener('click', loadSamplePrompts);
    document.getElementById('clear-btn').addEventListener('click', clearAll);
}

function updateRangeDisplay(inputId, displayId, formatter) {
    const input = document.getElementById(inputId);
    const display = document.getElementById(displayId);
    if (input && display) {
        display.textContent = formatter(input.value);
    }
}

function updateModelDependentOptions() {
    const model = document.getElementById('model').value;
    const isVeo3 = model.startsWith('veo-3');
    const isVeo2 = model.startsWith('veo-2');
    
    // Resolution only available for VEO 3
    const resolutionGroup = document.getElementById('resolution-group');
    if (resolutionGroup) {
        resolutionGroup.style.display = isVeo3 ? 'block' : 'none';
    }
    
    // Audio generation only for some models (disable for VEO 2)
    const audioGroup = document.getElementById('audio-group');
    const audioInput = document.getElementById('generate_audio');
    if (audioGroup && audioInput) {
        if (isVeo2) {
            audioGroup.style.opacity = '0.5';
            audioInput.disabled = true;
            audioInput.checked = false;
        } else {
            audioGroup.style.opacity = '1';
            audioInput.disabled = false;
        }
    }
    
    updateConfigSummary();
}

function updateConfigSummary() {
    const model = document.getElementById('model');
    const aspectRatio = document.querySelector('input[name="aspect_ratio"]:checked');
    const duration = document.getElementById('duration');
    const sampleCount = document.getElementById('sample_count');
    
    if (model) {
        document.getElementById('summary-model').textContent = model.options[model.selectedIndex].text.split(' (')[0];
    }
    
    if (aspectRatio) {
        document.getElementById('summary-aspect').textContent = aspectRatio.value;
    }
    
    if (duration) {
        document.getElementById('summary-duration').textContent = `${duration.value} seconds`;
    }
    
    if (sampleCount) {
        const count = sampleCount.value;
        document.getElementById('summary-samples').textContent = `${count} video${count > 1 ? 's' : ''}`;
    }
}

function toggleAdvancedOptions() {
    const toggle = document.getElementById('advanced-toggle');
    const options = document.getElementById('advanced-options');
    const icon = toggle.querySelector('i');
    
    if (options.classList.contains('show')) {
        options.classList.remove('show');
        icon.className = 'fas fa-chevron-down';
        toggle.innerHTML = '<i class="fas fa-chevron-down"></i> Advanced Options';
    } else {
        options.classList.add('show');
        icon.className = 'fas fa-chevron-up';
        toggle.innerHTML = '<i class="fas fa-chevron-up"></i> Advanced Options';
    }
}

function setupFileUpload() {
    const uploadArea = document.getElementById('image-upload-area');
    const fileInput = document.getElementById('image-input');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
}

function handleFileSelect(file) {
    if (!file.type.startsWith('image/')) {
        showAlert('Please select a valid image file.', 'danger');
        return;
    }
    
    if (file.size > 10 * 1024 * 1024) {
        showAlert('File size must be less than 10MB.', 'danger');
        return;
    }
    
    const preview = document.getElementById('image-preview');
    const fileName = document.getElementById('image-name');
    
    fileName.textContent = file.name;
    preview.classList.add('show');
}

function removeImage() {
    const preview = document.getElementById('image-preview');
    const fileInput = document.getElementById('image-input');
    
    preview.classList.remove('show');
    fileInput.value = '';
}

function validatePrompts() {
    const promptsText = document.getElementById('prompts').value.trim();
    
    if (!promptsText) {
        showAlert('Please enter at least one prompt.', 'danger');
        return;
    }
    
    // Try to parse as JSON first
    let prompts;
    try {
        prompts = JSON.parse(promptsText);
        if (!Array.isArray(prompts)) {
            throw new Error('JSON must be an array');
        }
    } catch (e) {
        // Treat as line-separated prompts
        prompts = promptsText.split('\n').filter(line => line.trim()).map(line => line.trim());
    }
    
    // Validate prompts
    if (prompts.length === 0) {
        showAlert('No valid prompts found.', 'danger');
        return;
    }
    
    if (prompts.length > 10) {
        showAlert('Maximum 10 prompts allowed per batch.', 'danger');
        return;
    }
    
    for (let i = 0; i < prompts.length; i++) {
        if (typeof prompts[i] !== 'string' || !prompts[i].trim()) {
            showAlert(`Prompt ${i + 1} is invalid or empty.`, 'danger');
            return;
        }
        if (prompts[i].length > 400) {
            showAlert(`Prompt ${i + 1} exceeds 400 character limit.`, 'danger');
            return;
        }
    }
    
    currentPrompts = prompts;
    validatedConfig = getCurrentConfig();
    
    document.getElementById('generate-btn').disabled = false;
    showAlert(`✓ Validated ${prompts.length} prompt${prompts.length > 1 ? 's' : ''} successfully!`, 'success');
    
    // Show results section
    document.getElementById('results-section').style.display = 'block';
    renderResultsGrid();
}

function getCurrentConfig() {
    const aspectRatio = document.querySelector('input[name="aspect_ratio"]:checked');
    
    const config = {
        model: document.getElementById('model').value,
        aspect_ratio: aspectRatio ? aspectRatio.value : '16:9',
        duration_seconds: parseInt(document.getElementById('duration').value),
        sample_count: parseInt(document.getElementById('sample_count').value),
        enhance_prompt: document.getElementById('enhance_prompt').checked,
        generate_audio: document.getElementById('generate_audio').checked,
        person_generation: document.getElementById('person_generation').value || null,
        negative_prompt: document.getElementById('negative_prompt').value.trim() || null,
        seed: document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : null,
        storage_uri: document.getElementById('storage_uri').value.trim() || null
    };
    
    // Only include resolution for VEO 3 models
    if (config.model.startsWith('veo-3')) {
        const resolution = document.getElementById('resolution').value;
        if (resolution) {
            config.resolution = resolution;
        }
    }
    
    return config;
}

function renderResultsGrid() {
    const grid = document.getElementById('results-grid');
    grid.innerHTML = '';
    
    currentPrompts.forEach((prompt, index) => {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
            <div class="result-header">
                <div class="result-prompt">${escapeHtml(prompt)}</div>
                <div class="result-status status-pending" id="status-${index}">Pending</div>
            </div>
            <div class="result-video" id="video-${index}" style="display: none;">
                <!-- Video will be inserted here -->
            </div>
        `;
        grid.appendChild(resultItem);
    });
}

async function generateVideos() {
    if (!currentPrompts.length || !validatedConfig) {
        showAlert('Please validate prompts first.', 'danger');
        return;
    }
    
    const generateBtn = document.getElementById('generate-btn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    try {
        const response = await fetch('/api/video/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompts: currentPrompts,
                options: validatedConfig
            })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to start generation');
        }
        
        currentJobId = data.job_id;
        showAlert(`✓ Generation started! Job ID: ${currentJobId}`, 'success');
        
        // Start listening to events
        listenToGenerationEvents(currentJobId);
        
    } catch (error) {
        showAlert(`Error: ${error.message}`, 'danger');
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-play"></i> Generate Videos';
    }
}

function listenToGenerationEvents(jobId) {
    const eventSource = new EventSource(`/api/video/stream/${jobId}`);
    
    eventSource.addEventListener('prompt.started', (event) => {
        const data = JSON.parse(event.data);
        updatePromptStatus(data.prompt_index, 'Generating', 'generating');
    });
    
    eventSource.addEventListener('prompt.completed', (event) => {
        const data = JSON.parse(event.data);
        updatePromptStatus(data.prompt_index, 'Completed', 'completed');
        
        if (data.video_url) {
            displayVideo(data.prompt_index, data.video_url);
        }
    });
    
    eventSource.addEventListener('prompt.failed', (event) => {
        const data = JSON.parse(event.data);
        updatePromptStatus(data.prompt_index, 'Failed', 'failed');
    });
    
    eventSource.addEventListener('job.completed', () => {
        eventSource.close();
        showAlert('✓ All videos generated successfully!', 'success');
        
        const generateBtn = document.getElementById('generate-btn');
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-play"></i> Generate Videos';
    });
    
    eventSource.addEventListener('error', () => {
        eventSource.close();
        showAlert('Connection lost. Please refresh to check results.', 'danger');
        
        const generateBtn = document.getElementById('generate-btn');
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-play"></i> Generate Videos';
    });
}

function updatePromptStatus(index, text, statusClass) {
    const statusElement = document.getElementById(`status-${index}`);
    if (statusElement) {
        statusElement.textContent = text;
        statusElement.className = `result-status status-${statusClass}`;
    }
}

function displayVideo(index, videoUrl) {
    const videoContainer = document.getElementById(`video-${index}`);
    if (videoContainer) {
        let src = videoUrl;
        
        // Handle local file paths
        if (!videoUrl.startsWith('http') && !videoUrl.startsWith('/')) {
            src = `/videos/${videoUrl.replace(/^generated_videos\/?/, '')}`;
        }
        
        videoContainer.innerHTML = `
            <video controls style="width: 100%; border-radius: 6px;">
                <source src="${src}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        `;
        videoContainer.style.display = 'block';
    }
}

function loadSamplePrompts() {
    const samples = [
        "A cat playing piano in a jazz bar, cinematic lighting, warm atmosphere",
        "Slow orbital shot of a futuristic eco city at sunrise, drone cinematography",
        "Drone flyover of terraced rice fields with morning mist, aerial view"
    ];
    
    document.getElementById('prompts').value = samples.join('\n');
    showAlert('Sample prompts loaded. Click "Validate Prompts" to continue.', 'success');
}

function clearAll() {
    document.getElementById('prompts').value = '';
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('generate-btn').disabled = true;
    currentPrompts = [];
    validatedConfig = null;
    currentJobId = null;
    
    // Clear alerts
    document.getElementById('alert-container').innerHTML = '';
    
    showAlert('All data cleared.', 'success');
}

function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alertId = 'alert-' + Date.now();
    
    const alert = document.createElement('div');
    alert.id = alertId;
    alert.className = `alert-studio alert-${type}`;
    alert.innerHTML = message;
    
    alertContainer.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        const element = document.getElementById(alertId);
        if (element) {
            element.remove();
        }
    }, 5000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}