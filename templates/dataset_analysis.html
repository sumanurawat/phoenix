<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset Analysis - Phoenix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
            margin-bottom: 2rem;
            height: calc(100vh - 4rem);
            overflow: hidden;
        }
        
        /* Modern Split View Layout */
        .split-container {
            display: flex;
            height: 100%;
            position: relative;
        }
        
        .main-content {
            flex: 1;
            min-width: 300px;
            overflow-y: auto;
            padding: 2rem;
            background: white;
            border-radius: 20px 0 0 20px;
        }
        
        .chat-panel {
            width: 45%;
            min-width: 400px;
            max-width: 70%;
            background: #f8fafc;
            border-radius: 0 20px 20px 0;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .chat-panel.collapsed {
            width: 0;
            min-width: 0;
            overflow: hidden;
        }
        
        .resizer {
            width: 6px;
            background: #e2e8f0;
            cursor: col-resize;
            user-select: none;
            position: relative;
            transition: background-color 0.2s;
        }
        
        .resizer:hover {
            background: #3b82f6;
        }
        
        .resizer::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 30px;
            background: rgba(107, 114, 128, 0.3);
            border-radius: 2px;
        }
        
        .resizer:hover::before {
            background: rgba(255, 255, 255, 0.8);
        }
        .analysis-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 2rem;
        }
        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .loading-spinner {
            display: none;
        }
        .loading-spinner.active {
            display: inline-block;
        }
        .dataset-info {
            background: rgba(79, 70, 229, 0.1);
            border-left: 4px solid #4f46e5;
            border-radius: 0 8px 8px 0;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .analysis-step {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .step-header {
            background: #f9fafb;
            padding: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .step-header:hover {
            background: #f3f4f6;
        }
        .step-content {
            padding: 1rem;
            display: none;
        }
        .step-content.active {
            display: block;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: transform 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        }
        .result-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .iteration-progress {
            margin-bottom: 1rem;
        }
        .iteration-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .iteration-box.active {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .iteration-box.success {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .iteration-box.error {
            border-color: #ef4444;
            background: #fef2f2;
        }
        .iteration-header {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .iteration-header:hover {
            background: rgba(79, 70, 229, 0.05);
        }
        .iteration-content {
            padding: 0 1rem 1rem 1rem;
            display: none;
            border-top: 1px solid #e2e8f0;
            background: white;
        }
        .iteration-content.show {
            display: block;
        }
        .iteration-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .iteration-timing {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: auto;
        }
        /* Chat Panel Styling */
        .chat-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-header h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .chat-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-controls .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chat-controls .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: white;
        }
        
        .conversation-message {
            margin-bottom: 1rem;
            border-radius: 8px;
            padding: 0;
            background: transparent;
            border: none;
        }
        
        .conversation-message.user {
            background: #f1f5f9;
            border-left: 4px solid #3b82f6;
            margin-right: 2rem;
        }
        
        .conversation-message.assistant {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            margin-left: 2rem;
        }
        
        .conversation-message.error {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            margin-left: 2rem;
        }
        
        .conversation-message.system {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            margin: 0 1rem;
            font-style: italic;
        }
        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 1rem 1rem 0 1rem;
        }
        
        .conversation-meta {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .conversation-content {
            font-size: 0.9rem;
            color: #1e293b;
            line-height: 1.6;
            padding: 0 1rem 1rem 1rem;
            word-wrap: break-word;
        }
        
        .conversation-content pre {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin: 0.75rem 0;
            overflow-x: auto;
            font-size: 0.875rem;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .conversation-content code {
            background: #f1f5f9;
            color: #0f172a;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 500;
        }
        
        .conversation-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        
        .conversation-tokens {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            gap: 1rem;
            padding: 0 1rem 1rem 1rem;
            border-top: 1px solid #f1f5f9;
            background: #f8fafc;
            margin-left: 1rem;
            margin-right: 1rem;
            border-radius: 0 0 6px 6px;
        }
        .conversation-avatar {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .conversation-avatar.user {
            background: #3b82f6;
            color: white;
        }
        .conversation-avatar.assistant {
            background: #10b981;
            color: white;
        }
        .conversation-avatar.error {
            background: #ef4444;
            color: white;
        }
        .conversation-avatar.system {
            background: #0ea5e9;
            color: white;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .split-container {
                flex-direction: column;
            }
            .chat-panel {
                width: 100% !important;
                min-width: unset;
                max-width: unset;
                height: 40%;
                border-left: none;
                border-top: 1px solid #e2e8f0;
                border-radius: 0;
            }
            .resizer {
                width: 100%;
                height: 6px;
                cursor: row-resize;
            }
            .main-content {
                border-radius: 20px 20px 0 0;
            }
        }
        .thinking-dots {
            display: inline-flex;
            gap: 0.2rem;
        }
        .thinking-dots span {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #4f46e5;
            animation: thinking 1.4s infinite ease-in-out;
        }
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes thinking {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }
        #conversationPanel {
            position: sticky;
            top: 20px;
            border: 2px solid #007bff !important;
            background: #ffffff !important;
            min-height: 500px !important;
        }
        
        /* Debug styles for conversation panel */
        .col-md-4 {
            background: #f8f9fa !important;
            border: 2px dashed #28a745 !important;
            min-height: 400px !important;
        }
        
        /* Make sure the conversation panel is always visible */
        @media (max-width: 768px) {
            .col-md-4 {
                margin-top: 20px;
                display: block !important;
            }
        }
        .conversation-message {
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem;
            margin-bottom: 0;
        }
        .conversation-message:last-child {
            border-bottom: none;
        }
        .conversation-message.user {
            background: #f8fafc;
            border-left: 3px solid #4f46e5;
        }
        .conversation-message.assistant {
            background: white;
            border-left: 3px solid #10b981;
        }
        .conversation-message.error {
            background: #fef2f2;
            border-left: 3px solid #ef4444;
        }
        .conversation-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .conversation-meta {
            font-size: 0.75rem;
            color: #6b7280;
            margin-left: auto;
        }
        .conversation-content {
            font-size: 0.875rem;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }
        .conversation-tokens {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            display: flex;
            gap: 1rem;
        }
        .stats-counter {
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="analysis-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-1">
                            <i class="fas fa-chart-line me-2"></i>Dataset Analysis
                        </h1>
                        <p class="mb-0 opacity-75">Automated analysis and insights for your dataset</p>
                    </div>
                    <div>
                        <a href="/datasets" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left me-1"></i>Back to Discovery
                        </a>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div style="height: calc(100% - 120px);">
                <!-- Real-time Stats Bar -->
                <div class="card mx-4 mt-4 mb-3" id="statsBar">
                    <div class="card-body py-2">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-coins text-warning me-2"></i>
                                    <div>
                                        <div class="small text-muted">Total Tokens</div>
                                        <div class="fw-bold stats-counter" id="totalTokens">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-dollar-sign text-success me-2"></i>
                                    <div>
                                        <div class="small text-muted">Estimated Cost</div>
                                        <div class="fw-bold stats-counter" id="totalCost">$0.00</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-sync text-info me-2"></i>
                                    <div>
                                        <div class="small text-muted">Total Iterations</div>
                                        <div class="fw-bold stats-counter" id="totalIterations">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-clock text-primary me-2"></i>
                                    <div>
                                        <div class="small text-muted">Total Time</div>
                                        <div class="fw-bold stats-counter" id="totalTime">0s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modern Split View Layout -->
                <div class="split-container" style="height: calc(100% - 120px); margin: 0 1rem;">
                    <!-- Main Content Panel -->
                    <div class="main-content">
                        <!-- Dataset Info -->
                <div class="dataset-info">
                    <h5><i class="fas fa-database me-2"></i>Dataset Information</h5>
                    <div class="row">
                        <div class="col-md-8">
                            <strong>Dataset:</strong> {{ dataset_ref }}
                        </div>
                        <div class="col-md-2">
                            <strong>Files:</strong> {{ file_count }}
                        </div>
                        <div class="col-md-2">
                            <strong>Size:</strong> {{ "%.1f"|format(size_mb) }} MB
                        </div>
                    </div>
                </div>

                <!-- Model Selection -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AI Model Selection</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="modelProvider" class="form-label">Provider</label>
                                <select id="modelProvider" class="form-select" onchange="updateAvailableModels()">
                                    <option value="gemini" selected>Google Gemini</option>
                                    <option value="claude" id="claudeOption">Anthropic Claude</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="modelName" class="form-label">Model</label>
                                <select id="modelName" class="form-select">
                                    <option value="gemini-1.5-flash-8b" selected>Gemini 1.5 Flash 8B (Fast & Cost-Effective)</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableIterativeMode" checked>
                                    <label class="form-check-label" for="enableIterativeMode">
                                        <strong>Iterative Mode</strong> - Retry until code works
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="maxIterations" class="form-label">Max Iterations</label>
                                <select id="maxIterations" class="form-select">
                                    <option value="3">3 (Conservative)</option>
                                    <option value="5" selected>5 (Balanced)</option>
                                    <option value="7">7 (Thorough)</option>
                                    <option value="10">10 (Extensive)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>üí∞ Cost Comparison:</strong> Iterative mode uses multiple API calls. 
                                    <strong class="text-primary">üöÄ localhost defaults to Claude 4 Sonnet for best coding quality!</strong>
                                    <br><small>
                                    üí∏ <strong>Budget:</strong> Gemini Flash (40-80x cheaper) ‚Ä¢ 
                                    ‚≠ê <strong>Balance:</strong> Claude 4 Sonnet ‚Ä¢ 
                                    üèÜ <strong>Premium:</strong> Claude 4 Opus (world's best coding)
                                    </small>
                                    <div id="costEstimate" class="small mt-1 fw-bold"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Controls -->
                <div class="mb-4">
                    <button id="startAnalysis" class="btn btn-primary btn-lg">
                        <i class="fas fa-play me-2"></i>Start Analysis
                    </button>
                    <button id="generateCode" class="btn btn-outline-secondary ms-2" disabled>
                        <i class="fas fa-code me-2"></i>Generate Analysis Code
                    </button>
                    <div class="loading-spinner ms-3" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Analyzing dataset...</span>
                    </div>
                </div>

                <!-- Analysis Steps -->
                <div id="analysisSteps">
                    <!-- Step 1: Data Loading -->
                    <div class="analysis-step">
                        <div class="step-header" onclick="toggleStep(1)">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-download me-2"></i>Step 1: Data Loading & Overview
                                </h6>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="step-content" id="step1Content">
                            <div id="step1Progress" class="iteration-progress"></div>
                            <div id="step1Results"></div>
                        </div>
                    </div>

                    <!-- Step 2: Data Exploration -->
                    <div class="analysis-step">
                        <div class="step-header" onclick="toggleStep(2)">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-search me-2"></i>Step 2: Data Exploration & Summary
                                </h6>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="step-content" id="step2Content">
                            <div id="step2Progress" class="iteration-progress"></div>
                            <div id="step2Results"></div>
                        </div>
                    </div>

                    <!-- Step 3: Column Analysis -->
                    <div class="analysis-step">
                        <div class="step-header" onclick="toggleStep(3)">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-columns me-2"></i>Step 3: Column-by-Column Analysis
                                </h6>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="step-content" id="step3Content">
                            <div id="step3Progress" class="iteration-progress"></div>
                            <div id="step3Results"></div>
                        </div>
                    </div>

                    <!-- Step 4: Insights & Recommendations -->
                    <div class="analysis-step">
                        <div class="step-header" onclick="toggleStep(4)">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-lightbulb me-2"></i>Step 4: AI Insights & Recommendations
                                </h6>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="step-content" id="step4Content">
                            <div id="step4Progress" class="iteration-progress"></div>
                            <div id="step4Results"></div>
                        </div>
                    </div>
                </div>

                <!-- Generated Code Section -->
                <div id="generatedCodeSection" style="display: none;">
                    <h5><i class="fas fa-code me-2"></i>Generated Analysis Code</h5>
                    <p class="text-muted">This temporary code was generated to analyze your dataset:</p>
                    <div class="code-output" id="generatedCode"></div>
                    <div class="mt-3">
                        <button class="btn btn-outline-primary" onclick="copyCode()">
                            <i class="fas fa-copy me-2"></i>Copy Code
                        </button>
                        <small class="text-muted ms-3">
                            <i class="fas fa-info-circle me-1"></i>
                            This code is temporary and will be deleted after analysis
                        </small>
                    </div>
                </div>
                    </div> <!-- End Main Content -->
                    
                    <!-- Resizable Splitter -->
                    <div class="resizer" id="resizer"></div>
                    
                    <!-- Chat Panel -->
                    <div class="chat-panel" id="chatPanel">
                        <div class="chat-header">
                            <h6>
                                <i class="fas fa-robot me-2"></i>Model Conversation
                            </h6>
                            <div class="chat-controls">
                                <button class="btn btn-sm" onclick="toggleChatPanel()" id="chatToggle">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="btn btn-sm" onclick="clearConversation()">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chat-body" id="conversationBody">
                            <div id="conversationList">
                                <div class="text-muted text-center small p-4">
                                    <i class="fas fa-robot me-1"></i>
                                    Model interactions will appear here...
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Split Container -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/model-selector.js') }}"></script>
    <script>
        // Global variables
        const datasetRef = '{{ dataset_ref }}';
        const fileCount = {{ file_count }};
        const sizeMb = {{ size_mb }};
        let analysisResults = {};
        let totalStats = {
            tokens: 0,
            cost: 0,
            iterations: 0,
            time: 0
        };

        // Load real conversation messages from API
        async function loadConversationMessages(conversationId) {
            if (!conversationId) return;
            
            try {
                console.log(`üì° Loading conversation messages for ${conversationId}`);
                
                const response = await fetch(`/api/datasets/conversation/${conversationId}`);
                const data = await response.json();
                
                if (data.success && data.messages) {
                    // Clear existing conversation display
                    const conversationList = document.getElementById('conversationList');
                    conversationList.innerHTML = '';
                    
                    console.log(`üí¨ Loaded ${data.messages.length} messages`);
                    
                    // Add each message to the conversation panel
                    data.messages.forEach(message => {
                        const messageType = message.role === 'user' ? 'user' : 'assistant';
                        const title = message.metadata?.title || `${message.role} message`;
                        const content = message.content;
                        
                        // Calculate duration from metadata
                        const executionTime = message.metadata?.execution_time || 0;
                        const generationTime = message.metadata?.generation_time || 0;
                        const duration = executionTime + generationTime;
                        
                        // Get token info
                        const tokens = message.metadata?.tokens || {};
                        
                        addConversationMessage(messageType, title, content, {
                            duration: duration > 0 ? duration.toFixed(1) : '',
                            tokens: tokens,
                            timestamp: message.timestamp
                        });
                    });
                    
                } else {
                    console.warn('Failed to load conversation messages:', data.error);
                }
            } catch (error) {
                console.error('Error loading conversation messages:', error);
            }
        }

        // Conversation Panel Functions
        function addConversationMessage(type, title, content, metadata = {}) {
            const conversationList = document.getElementById('conversationList');
            
            // Clear placeholder if it exists
            const placeholder = conversationList.querySelector('.text-muted.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const message = document.createElement('div');
            message.className = `conversation-message ${type}`;
            message.id = messageId;
            
            // Avatar letters
            const avatarLetter = type === 'user' ? 'U' : 
                               type === 'assistant' ? 'AI' : 
                               type === 'error' ? '!' : 
                               type === 'system' ? 'S' : '?';
            
            // Process content for markdown-like rendering
            const processedContent = renderSimpleMarkdown(content);
            
            message.innerHTML = `
                <div class="conversation-header">
                    <div class="d-flex align-items-center">
                        <div class="conversation-avatar ${type} me-2">
                            ${avatarLetter}
                        </div>
                        <strong style="color: #2d2d2d; font-size: 0.95rem;">${title}</strong>
                    </div>
                    <div class="conversation-meta">
                        ${formatTimestamp(metadata.timestamp)}
                        ${metadata.duration ? ` ‚Ä¢ ${metadata.duration}s` : ''}
                    </div>
                </div>
                <div class="conversation-content">
                    ${processedContent}
                </div>
                ${metadata.tokens ? `
                    <div class="conversation-tokens">
                        <span><i class="fas fa-arrow-up me-1"></i>${metadata.tokens.input || 0} tokens</span>
                        <span><i class="fas fa-arrow-down me-1"></i>${metadata.tokens.output || 0} tokens</span>
                        ${metadata.tokens.cost ? `<span><i class="fas fa-dollar-sign me-1"></i>$${metadata.tokens.cost.toFixed(4)}</span>` : ''}
                    </div>
                ` : ''}
            `;
            
            conversationList.appendChild(message);
            
            // Auto-scroll to bottom
            const conversationBody = document.getElementById('conversationBody');
            conversationBody.scrollTop = conversationBody.scrollHeight;
            
            return messageId;
        }
        
        function renderSimpleMarkdown(text) {
            if (!text) return '';
            
            // Handle code blocks
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // Handle inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Handle bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Handle line breaks
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return new Date().toLocaleTimeString();
            const date = new Date(timestamp * 1000); // Convert from Unix timestamp
            return date.toLocaleTimeString();
        }
        
        function updateStats(newTokens = 0, newCost = 0, newIterations = 0, newTime = 0) {
            totalStats.tokens += newTokens;
            totalStats.cost += newCost;
            totalStats.iterations += newIterations;
            totalStats.time += newTime;
            
            document.getElementById('totalTokens').textContent = totalStats.tokens.toLocaleString();
            document.getElementById('totalCost').textContent = `$${totalStats.cost.toFixed(4)}`;
            document.getElementById('totalIterations').textContent = totalStats.iterations;
            document.getElementById('totalTime').textContent = `${totalStats.time.toFixed(1)}s`;
        }
        
        function clearConversation() {
            const conversationList = document.getElementById('conversationList');
            conversationList.innerHTML = `
                <div class="text-muted text-center small p-4">
                    <i class="fas fa-robot me-1"></i>
                    Model interactions will appear here...
                </div>
            `;
            
            // Reset stats when clearing conversation
            totalStats = { tokens: 0, cost: 0, iterations: 0, time: 0 };
            updateStats(0, 0, 0, 0);
        }
        
        // Modern Split Panel Controls
        function toggleChatPanel() {
            const chatPanel = document.getElementById('chatPanel');
            const chatToggle = document.getElementById('chatToggle');
            const icon = chatToggle.querySelector('i');
            
            if (chatPanel.classList.contains('collapsed')) {
                chatPanel.classList.remove('collapsed');
                icon.className = 'fas fa-chevron-left';
            } else {
                chatPanel.classList.add('collapsed');
                icon.className = 'fas fa-chevron-right';
            }
        }
        
        // Resizable Splitter Functionality
        function initializeResizer() {
            const resizer = document.getElementById('resizer');
            const mainContent = document.querySelector('.main-content');
            const chatPanel = document.getElementById('chatPanel');
            const splitContainer = document.querySelector('.split-container');
            
            let isResizing = false;
            
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', () => {
                    isResizing = false;
                    document.removeEventListener('mousemove', handleMouseMove);
                });
                e.preventDefault();
            });
            
            function handleMouseMove(e) {
                if (!isResizing) return;
                
                const containerRect = splitContainer.getBoundingClientRect();
                const mouseX = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;
                
                // Calculate new widths as percentages
                const mainContentPercent = (mouseX / containerWidth) * 100;
                const chatPanelPercent = 100 - mainContentPercent;
                
                // Set minimum and maximum widths
                if (mainContentPercent >= 30 && chatPanelPercent >= 25) {
                    mainContent.style.flex = `0 0 ${mainContentPercent}%`;
                    chatPanel.style.width = `${chatPanelPercent}%`;
                }
            }
        }
        
        // Initialize resizer and environment when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dataset Analysis: DOM loaded, initializing...');
            console.log('startAnalysis function available:', typeof startAnalysis);
            console.log('toggleMessage function available:', typeof toggleMessage);
            console.log('globalModelSelector available:', typeof globalModelSelector);
            
            initializeResizer();
            initializeEnvironment();
        });

        // Toggle step visibility
        function toggleStep(stepNumber) {
            const content = document.getElementById(`step${stepNumber}Content`);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.className = 'fas fa-chevron-down';
            } else {
                content.classList.add('active');
                icon.className = 'fas fa-chevron-up';
            }
        }

        // Initialize model selector component (handled by model-selector.js)
        // Component provides: updateAvailableModels(), getCurrentModelConfig(), calculateModelCost()
        
        // Initialize environment-specific UI
        function initializeEnvironment() {
            // The model selector component handles all model selection logic
            // Just update cost estimate when models change
            setTimeout(updateCostEstimate, 100); // Wait for component to initialize
            
            // Add event listeners for model changes to update cost estimates
            const providerSelect = document.getElementById('modelProvider');
            const modelSelect = document.getElementById('modelName');
            const iterativeMode = document.getElementById('enableIterativeMode');
            const maxIterations = document.getElementById('maxIterations');
            
            if (providerSelect) {
                providerSelect.addEventListener('change', updateCostEstimate);
            }
            if (modelSelect) {
                modelSelect.addEventListener('change', updateCostEstimate);
            }
            if (iterativeMode) {
                iterativeMode.addEventListener('change', updateCostEstimate);
            }
            if (maxIterations) {
                maxIterations.addEventListener('change', updateCostEstimate);
            }
        }

        // Update cost estimate based on selection
        function updateCostEstimate() {
            if (!globalModelSelector) return; // Component not ready yet
            
            const provider = globalModelSelector.getCurrentProvider();
            const modelId = globalModelSelector.getCurrentModel();
            const iterativeMode = document.getElementById('enableIterativeMode').checked;
            const maxIterations = parseInt(document.getElementById('maxIterations').value);
            const costDiv = document.getElementById('costEstimate');
            
            const selectedModel = globalModelSelector.getModelInfo(provider, modelId);
            
            if (selectedModel) {
                let estimate = '';
                if (iterativeMode) {
                    estimate = `Est. cost: ${selectedModel.cost} √ó ${maxIterations} iterations = `;
                    if (selectedModel.cost === 'Very Low') estimate += '$0.01-0.05';
                    else if (selectedModel.cost === 'Low') estimate += '$0.05-0.20';
                    else if (selectedModel.cost === 'Medium') estimate += '$0.20-0.50';
                    else if (selectedModel.cost === 'High') estimate += '$0.50-2.00';
                    else if (selectedModel.cost === 'Very High') estimate += '$2.00-10.00';
                } else {
                    estimate = `Est. cost: ${selectedModel.cost} (single run)`;
                }
                costDiv.textContent = estimate;
            }
        }

        // Get selected model configuration
        function getModelConfig() {
            if (globalModelSelector) {
                const config = globalModelSelector.getCurrentConfig();
                return {
                    provider: config.provider,
                    model: config.model,
                    enable_thinking: config.enable_thinking,
                    thinking_budget: config.thinking_budget,
                    iterative_mode: document.getElementById('enableIterativeMode').checked,
                    max_iterations: parseInt(document.getElementById('maxIterations').value)
                };
            } else {
                // Fallback if component not ready
                return {
                    provider: document.getElementById('modelProvider').value,
                    model: document.getElementById('modelName').value,
                    enable_thinking: false,
                    thinking_budget: 2048,
                    iterative_mode: document.getElementById('enableIterativeMode').checked,
                    max_iterations: parseInt(document.getElementById('maxIterations').value)
                };
            }
        }

        // Start analysis process
        async function startAnalysis() {
            const startBtn = document.getElementById('startAnalysis');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const generateBtn = document.getElementById('generateCode');
            const modelConfig = getModelConfig();
            
            // Reset stats for new analysis
            totalStats = { tokens: 0, cost: 0, iterations: 0, time: 0 };
            updateStats(0, 0, 0, 0);
            
            // Update UI
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
            loadingSpinner.classList.add('active');
            
            // Update loading text to show model being used
            const loadingText = loadingSpinner.querySelector('span');
            loadingText.textContent = `Analyzing with ${modelConfig.provider} ${modelConfig.model}...`;
            
            try {
                // Step 1: Generate and run analysis code
                await runAnalysisStep(1, 'Loading and exploring data structure');
                
                // Step 2: Data exploration
                await runAnalysisStep(2, 'Performing statistical analysis');
                
                // Step 3: Column analysis
                await runAnalysisStep(3, 'Analyzing individual columns');
                
                // Step 4: AI insights
                await runAnalysisStep(4, 'Generating insights and recommendations');
                
                // Enable code generation
                generateBtn.disabled = false;
                
                alert('Analysis completed successfully! Review the results below.');
                
            } catch (error) {
                console.error('Analysis failed:', error);
                alert(`Analysis failed: ${error.message}`);
            } finally {
                // Restore UI
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Analysis';
                loadingSpinner.classList.remove('active');
            }
        }

        // Run individual analysis step
        async function runAnalysisStep(stepNumber, description) {
            console.log(`Running step ${stepNumber}: ${description}`);
            const modelConfig = getModelConfig();
            
            // Add initial progress note
            addProgressNote(stepNumber, `Starting ${description} with ${modelConfig.provider} ${modelConfig.model}`);
            
            // Auto-expand the step to show progress
            const content = document.getElementById(`step${stepNumber}Content`);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');
            content.classList.add('active');
            icon.className = 'fas fa-chevron-up';
            
            try {
                const response = await fetch('/api/datasets/analyze/step', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dataset_ref: datasetRef,
                        step: stepNumber,
                        description: description,
                        model_config: modelConfig
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store results
                    analysisResults[`step${stepNumber}`] = data.result;
                    
                    // Load real conversation if conversation_id is available
                    if (data.result.conversation_id) {
                        loadConversationMessages(data.result.conversation_id);
                    }
                    
                    // Show iterations progress if available
                    if (data.result.iterations && data.result.iterations.length > 0) {
                        addProgressNote(stepNumber, `Completed in ${data.result.iterations.length} iteration(s)`, 'success');
                        
                        // Display each iteration
                        data.result.iterations.forEach((iteration, index) => {
                            const iterationId = createIterationBox(stepNumber, index + 1, iteration.success ? 'success' : 'error');
                            
                            // Update global stats
                            const tokens = (iteration.prompt_tokens || 0) + (iteration.completion_tokens || 0);
                            const cost = (iteration.prompt_tokens || 0) * 0.000003 + (iteration.completion_tokens || 0) * 0.000015;
                            const time = (iteration.generation_time || 0) + (iteration.execution_time || 0);
                            updateStats(tokens, cost, 1, time);
                            
                            let content = `
                                <div class="row small text-muted mb-2">
                                    <div class="col-md-6"><strong>Model:</strong> ${iteration.model_used || 'Unknown'}</div>
                                    <div class="col-md-3"><strong>Generation:</strong> ${iteration.generation_time ? iteration.generation_time.toFixed(1) + 's' : 'N/A'}</div>
                                    <div class="col-md-3"><strong>Execution:</strong> ${iteration.execution_time ? iteration.execution_time.toFixed(1) + 's' : 'N/A'}</div>
                                </div>
                            `;
                            
                            if (iteration.phase_description) {
                                content += `<div class="small text-info mb-2"><strong>Phase:</strong> ${escapeHtml(iteration.phase_description)}</div>`;
                            }
                            
                            if (iteration.prompt_tokens || iteration.completion_tokens) {
                                content += `<div class="small text-muted mb-2"><strong>Tokens:</strong> ${iteration.prompt_tokens || 0} in / ${iteration.completion_tokens || 0} out</div>`;
                            }
                            
                            if (iteration.success) {
                                content += `<div class="text-success mb-2"><i class="fas fa-check-circle me-1"></i>Code executed successfully</div>`;
                                if (iteration.execution_result) {
                                    content += `<div class="code-output small">${escapeHtml(iteration.execution_result.substring(0, 400))}${iteration.execution_result.length > 400 ? '...' : ''}</div>`;
                                }
                            } else {
                                content += `<div class="text-danger mb-2"><i class="fas fa-exclamation-circle me-1"></i>Execution failed</div>`;
                                if (iteration.error_message) {
                                    content += `<div class="text-danger small mb-2"><strong>Error:</strong> ${escapeHtml(iteration.error_message)}</div>`;
                                }
                                if (iteration.code) {
                                    content += `<details class="mt-2"><summary class="small text-muted">View generated code</summary><div class="code-output small mt-1">${escapeHtml(iteration.code.substring(0, 500))}${iteration.code.length > 500 ? '...' : ''}</div></details>`;
                                }
                            }
                            
                            updateIterationStatus(iterationId, iteration.success ? 'success' : 'error', {
                                executionTime: iteration.execution_time || 0,
                                content: content
                            });
                        });
                    }
                    
                    // Display final results
                    displayStepResults(stepNumber, data.result);
                    
                } else {
                    addProgressNote(stepNumber, `Failed: ${data.error?.message || 'Unknown error'}`, 'danger');
                    throw new Error(data.error?.message || `Step ${stepNumber} failed`);
                }
            } catch (error) {
                addProgressNote(stepNumber, `Error: ${error.message}`, 'danger');
                throw error;
            }
        }

        // Progress tracking functions
        function createIterationBox(stepNumber, iterationNumber, status = 'pending') {
            const progressContainer = document.getElementById(`step${stepNumber}Progress`);
            const iterationId = `iteration-${stepNumber}-${iterationNumber}`;
            
            const box = document.createElement('div');
            box.className = `iteration-box ${status}`;
            box.id = iterationId;
            
            const statusIcon = status === 'pending' ? '‚è≥' : 
                              status === 'active' ? 'ü§ñ' :
                              status === 'success' ? '‚úÖ' : '‚ùå';
            
            const statusText = status === 'pending' ? 'Queued' :
                              status === 'active' ? 'Generating Code' :
                              status === 'success' ? 'Completed' : 'Failed';
            
            box.innerHTML = `
                <div class="iteration-header" onclick="toggleIteration('${iterationId}')">
                    <div class="iteration-status">
                        <span class="status-icon">${statusIcon}</span>
                        <strong>Iteration ${iterationNumber}</strong>
                        <span class="status-text">${statusText}</span>
                        ${status === 'active' ? '<div class="thinking-dots ms-2"><span></span><span></span><span></span></div>' : ''}
                    </div>
                    <div class="iteration-timing" id="${iterationId}-timing"></div>
                </div>
                <div class="iteration-content" id="${iterationId}-content">
                    <div class="iteration-details"></div>
                </div>
            `;
            
            progressContainer.appendChild(box);
            return iterationId;
        }
        
        function updateIterationStatus(iterationId, status, details = {}) {
            const box = document.getElementById(iterationId);
            if (!box) return;
            
            // Update status class
            box.className = `iteration-box ${status}`;
            
            const statusIcon = box.querySelector('.status-icon');
            const statusText = box.querySelector('.status-text');
            const timing = box.querySelector(`#${iterationId}-timing`);
            const thinkingDots = box.querySelector('.thinking-dots');
            
            // Update icon and text
            if (status === 'active') {
                statusIcon.textContent = 'ü§ñ';
                statusText.textContent = details.phase || 'Processing';
                if (!thinkingDots) {
                    statusText.insertAdjacentHTML('afterend', '<div class="thinking-dots ms-2"><span></span><span></span><span></span></div>');
                }
            } else if (status === 'success') {
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = 'Completed';
                if (thinkingDots) thinkingDots.remove();
            } else if (status === 'error') {
                statusIcon.textContent = '‚ùå';
                statusText.textContent = 'Failed';
                if (thinkingDots) thinkingDots.remove();
            }
            
            // Update timing
            if (details.executionTime) {
                timing.textContent = `${details.executionTime.toFixed(1)}s`;
            }
            
            // Update content
            const contentDiv = box.querySelector('.iteration-details');
            if (details.content) {
                contentDiv.innerHTML = details.content;
            }
        }
        
        function toggleIteration(iterationId) {
            const content = document.querySelector(`#${iterationId}-content`);
            content.classList.toggle('show');
        }
        
        function addProgressNote(stepNumber, message, type = 'info') {
            const progressContainer = document.getElementById(`step${stepNumber}Progress`);
            const note = document.createElement('div');
            note.className = `alert alert-${type} py-2 px-3 mb-2`;
            note.innerHTML = `
                <small>
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>${new Date().toLocaleTimeString()}:</strong> ${message}
                </small>
            `;
            progressContainer.appendChild(note);
        }

        // Display step results
        function displayStepResults(stepNumber, result) {
            const container = document.getElementById(`step${stepNumber}Results`);
            
            let html = '<div class="result-card">';
            
            // Show fallback info if used
            if (result.fallback_info && result.fallback_info.fallback_used) {
                html += `<div class="alert alert-warning"><i class="fas fa-exchange-alt me-2"></i>
                    <strong>Fallback Used:</strong> Claude failed, automatically switched to Gemini 1.5 Flash for ${result.fallback_info.fallback_iterations} iteration(s).
                </div>`;
            }
            
            if (result.output) {
                html += `<h6><i class="fas fa-terminal me-2"></i>Analysis Output</h6>`;
                html += `<div class="code-output">${escapeHtml(result.output)}</div>`;
            }
            
            if (result.insights && result.insights.length > 0) {
                html += `<h6 class="mt-3"><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>`;
                html += '<ul>';
                result.insights.forEach(insight => {
                    html += `<li>${escapeHtml(insight)}</li>`;
                });
                html += '</ul>';
            }
            
            if (result.recommendations && result.recommendations.length > 0) {
                html += `<h6 class="mt-3"><i class="fas fa-star me-2"></i>Recommendations</h6>`;
                html += '<ul>';
                result.recommendations.forEach(rec => {
                    html += `<li>${escapeHtml(rec)}</li>`;
                });
                html += '</ul>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Generate and show analysis code
        async function generateAnalysisCode() {
            const generateBtn = document.getElementById('generateCode');
            const codeSection = document.getElementById('generatedCodeSection');
            const codeElement = document.getElementById('generatedCode');
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            
            try {
                const response = await fetch('/api/datasets/generate-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dataset_ref: datasetRef,
                        analysis_results: analysisResults
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    codeElement.textContent = data.code;
                    codeSection.style.display = 'block';
                    codeSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.error?.message || 'Code generation failed');
                }
                
            } catch (error) {
                console.error('Code generation failed:', error);
                alert(`Code generation failed: ${error.message}`);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-code me-2"></i>Generate Analysis Code';
            }
        }

        // Copy generated code to clipboard
        function copyCode() {
            const codeElement = document.getElementById('generatedCode');
            navigator.clipboard.writeText(codeElement.textContent).then(() => {
                // Show feedback
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
                btn.className = 'btn btn-success';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.className = 'btn btn-outline-primary';
                }, 2000);
            });
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.getElementById('startAnalysis').addEventListener('click', startAnalysis);
        document.getElementById('generateCode').addEventListener('click', generateAnalysisCode);
        document.getElementById('modelProvider').addEventListener('change', updateAvailableModels);
        document.getElementById('modelName').addEventListener('change', updateCostEstimate);
        document.getElementById('enableIterativeMode').addEventListener('change', updateCostEstimate);
        document.getElementById('maxIterations').addEventListener('change', updateCostEstimate);
        
        // Initialize model selection on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAvailableModels();
            updateCostEstimate();
            
            // Chat panel starts empty - stats will update during actual analysis
        });
    </script>
</body>
</html>