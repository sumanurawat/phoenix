<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset Analysis Chat - Phoenix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #667eea;
            --user-bubble: #3b82f6;
            --ai-bubble: #f8fafc;
            --ai-border: #e2e8f0;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --chat-background: #ffffff;
            --sidebar-background: #fafbfc;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--chat-background);
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* Main Layout - Full Width like Claude/ChatGPT */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            background: white;
        }

        /* Top Control Bar */
        .control-bar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .control-bar h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .control-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .model-selector select {
            background: transparent;
            border: none;
            color: white;
            font-size: 0.875rem;
        }

        .model-selector select option {
            background: var(--primary-color);
            color: white;
        }

        .model-selector select option:disabled {
            background: #f3f4f6 !important;
            color: #9ca3af !important;
            font-style: italic;
        }

        /* Stats Bar */
        .stats-bar {
            background: var(--sidebar-background);
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            flex-shrink: 0;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
            font-family: 'Monaco', monospace;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: help;
        }

        .stat-value:hover {
            transform: scale(1.05);
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Chat Messages Area - Full Width */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: var(--chat-background);
            padding: 0;
        }

        /* Message Bubbles - Claude/ChatGPT Style */
        .message {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 1.5rem 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .message.user {
            background: #f7f7f8;
        }

        .message.ai {
            background: white;
        }

        .message.system {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
        }

        .message.chart {
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
        }

        .message.debug {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            display: none; /* Hidden by default */
            margin: 0.5rem 0;
        }

        .message.debug.visible {
            display: flex;
        }

        /* Debug Container within steps */
        .debug-container {
            background: rgba(79, 70, 229, 0.02);
            border: 1px dashed var(--primary-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .debug-container h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .debug-container .message {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .debug-container .message-header {
            padding: 0.5rem;
        }

        .debug-container .message-title {
            font-size: 0.85rem;
        }

        .debug-container .api-call-info {
            font-size: 0.7rem;
        }

        /* Debug message content styling */
        .debug-message-content h6 {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .code-snippet {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.75rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Plot visualization styles */
        .plot-container {
            margin: 1rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            overflow: hidden;
        }

        .plot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plot-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .plot-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .plot-content {
            padding: 1.5rem;
            display: none;
            border-top: 1px solid #e2e8f0;
        }

        .plot-content.expanded {
            display: block;
        }

        .plot-description {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .plot-insights {
            background: #f8fafc;
            border-left: 4px solid #4f46e5;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0 6px 6px 0;
        }

        .plot-insights h6 {
            color: #4f46e5;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .debug-controls {
            margin-right: 1rem;
        }

        .debug-controls .form-check-input:checked {
            background-color: #10b981;
            border-color: #10b981;
        }

        .message-bubble {
            width: 100%;
            max-width: min(90vw, 75rem);
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            overflow: visible;
            background: transparent;
        }

        .message.user .message-bubble {
            background: transparent;
            color: #374151;
        }

        .message.ai .message-bubble {
            background: transparent;
            color: #374151;
        }

        /* Message Header - Claude Style */
        .message-header {
            padding: 0 0 1rem 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            background: transparent;
            margin-bottom: 1rem;
        }

        .message.user .message-header {
            background: transparent;
            border-bottom-color: #d1d5db;
        }

        .message-title {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message-meta {
            font-size: 0.75rem;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .api-call-info {
            display: flex;
            gap: 0.5rem;
            font-size: 0.7rem;
            background: rgba(79, 70, 229, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .token-info {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .cost-info {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .expand-icon {
            transition: transform 0.2s ease;
            font-size: 0.75rem;
        }

        .message-header.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Message Content - Full Width */
        .message-content {
            padding: 0;
            display: none;
        }

        .message-content.expanded {
            display: block;
            animation: expandContent 0.3s ease-out;
        }

        @keyframes expandContent {
            from {
                opacity: 0;
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
                padding-top: 1.25rem;
                padding-bottom: 1.25rem;
            }
        }

        /* Analysis Steps as Chat Cards - Full Width */
        .analysis-step-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .analysis-step-card.expanded {
            background: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }

        .analysis-step-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }

        .analysis-step-card.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .analysis-step-card.completed {
            border-color: var(--success-color);
        }

        .analysis-step-card.error {
            border-color: var(--error-color);
        }

        .step-header {
            padding: 1rem 1.25rem;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .step-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #374151;
        }

        .step-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge.pending {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-badge.running {
            background: #dbeafe;
            color: var(--primary-color);
        }

        .status-badge.completed {
            background: #d1fae5;
            color: var(--success-color);
        }

        .status-badge.error {
            background: #fee2e2;
            color: var(--error-color);
        }

        /* Analysis Results */
        .analysis-results {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 0.75rem 0;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            line-height: 1.6;
        }

        .expanded .analysis-results {
            padding: 2rem;
            margin: 1rem 0;
            font-size: 1rem;
        }

        .analysis-results h3 {
            color: var(--primary-color);
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .analysis-results h4 {
            color: #374151;
            font-size: 1rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem 0;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-card .label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            font-family: 'Monaco', monospace;
        }

        .data-table {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
            font-size: 0.875rem;
            overflow-x: auto;
        }

        .expanded .data-table {
            font-size: 0.95rem;
            margin: 1.5rem 0;
        }

        .expanded .data-table table {
            min-width: 600px;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-table tr:nth-child(even) {
            background: #f9fafb;
        }

        .insight-item {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border-left: 4px solid var(--success-color);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .warning-item {
            background: linear-gradient(135deg, #fef3c7 0%, #fef7cd 100%);
            border-left: 4px solid var(--warning-color);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .error-item {
            background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
            border-left: 4px solid var(--error-color);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        /* Code snippets when needed */
        .code-snippet {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            color: #374151;
            margin: 0.5rem 0;
            overflow-x: auto;
        }

        /* Loading Animation */
        .thinking-dots {
            display: inline-flex;
            gap: 0.25rem;
            align-items: center;
        }

        .thinking-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary-color);
            animation: thinking 1.4s infinite ease-in-out;
        }

        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes thinking {
            0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }

        /* Conversation Input Area */
        .conversation-input {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .input-container {
            max-width: min(90vw, 75rem);
            margin: 0 auto;
            display: flex;
            gap: 0.75rem;
            align-items: end;
        }

        .message-input {
            flex: 1;
            min-height: 2.5rem;
            max-height: 12rem;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            resize: none;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.5;
            overflow-y: auto;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .send-button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 4rem;
        }

        .send-button:hover:not(:disabled) {
            background: #3730a3;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Action Buttons - Updated */
        .action-buttons {
            padding: 1.5rem;
            background: var(--sidebar-background);
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 1rem;
            justify-content: center;
            max-width: min(90vw, 75rem);
            margin: 0 auto;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }

        /* Responsive Design - Mobile First */
        @media (max-width: 768px) {
            .control-bar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .control-actions {
                width: 100%;
                justify-content: space-between;
            }

            .message {
                padding: 1rem 0.5rem;
            }

            .message-bubble {
                max-width: none;
            }

            .stats-bar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .stat-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .action-buttons {
                padding: 1rem;
            }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Top Control Bar -->
        <div class="control-bar">
            <div class="d-flex align-items-center gap-3">
                <h1><i class="fas fa-chart-line me-2"></i>Dataset Analysis Chat</h1>
                <div class="small opacity-75">{{ dataset_ref|e }}</div>
            </div>
            
            <div class="control-actions">
                <div class="model-selector">
                    <i class="fas fa-robot me-2"></i>
                    <select id="modelProvider">
                        <option value="gemini" selected>Gemini</option>
                        <option value="claude" id="claudeOption">Claude</option>
                        <option value="grok" id="grokOption">Grok</option>
                    </select>
                    <select id="modelName" class="ms-2">
                        <option value="gemini-1.5-flash-8b">Flash 8B</option>
                    </select>
                    
                    <!-- Thinking mode removed for simplicity - will be re-implemented later -->
                </div>
                
                <!-- Debug mode removed for simplicity -->
                
                <button class="btn btn-sm btn-outline-light" id="clearChatBtn">
                    <i class="fas fa-trash me-1"></i>Clear
                </button>
                
                <button class="btn btn-sm btn-outline-light" id="goBackBtn">
                    <i class="fas fa-arrow-left me-1"></i>Back
                </button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-label">Total Tokens</div>
                <div class="stat-value" id="totalTokens" title="Click for breakdown">0</div>
                <div class="small text-muted mt-1" id="tokenBreakdown" style="font-size: 0.65rem;">Input: 0 | Output: 0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Estimated Cost</div>
                <div class="stat-value" id="totalCost" title="Real-time calculation based on current model">$0.0000</div>
                <div class="small text-muted mt-1" id="modelInfo" style="font-size: 0.65rem;">Gemini Flash 8B</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Iterations</div>
                <div class="stat-value" id="totalIterations">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Total Time</div>
                <div class="stat-value" id="totalTime">0s</div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome Message -->
            <div class="message ai">
                <div class="message-bubble">
                    <div class="message-header" data-toggle="message">
                        <div class="message-title">
                            <i class="fas fa-robot"></i>
                            Welcome to Dataset Analysis
                        </div>
                        <div class="message-meta">
                            <span>Just now</span>
                            <i class="fas fa-chevron-down expand-icon"></i>
                        </div>
                    </div>
                    <div class="message-content">
                        <p>I'll help you analyze your dataset <strong>{{ dataset_ref|e }}</strong> step by step. I'll run automated analysis and provide insights, visualizations, and recommendations.</p>
                        <p><strong>Analysis includes:</strong></p>
                        <ul>
                            <li>📊 Data loading and structure exploration</li>
                            <li>🔍 Statistical analysis and summaries</li>
                            <li>📈 Column-by-column deep dive</li>
                            <li>💡 AI-powered insights and recommendations</li>
                        </ul>
                        <p>Click "Start Analysis" below to begin!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" id="actionButtons">
            <button class="btn-primary" id="startAnalysis">
                <i class="fas fa-play"></i>
                Start Analysis
            </button>
            
            <button class="btn btn-outline-secondary" id="regenerateBtn" style="display: none;">
                <i class="fas fa-redo"></i>
                Regenerate
            </button>
        </div>

        <!-- Conversation Input -->
        <div class="conversation-input" id="conversationInput" style="display: none;">
            <div class="input-container">
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Ask for more analysis, charts, or insights about your dataset..."
                    rows="1"
                    onkeydown="handleInputKeydown(event)"
                    oninput="autoResizeInput(this)">
                </textarea>
                <button class="send-button" id="sendButton" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/model-selector.js') }}"></script>
    <script>
        // Global variables
        const datasetRef = '{{ dataset_ref|e }}';
        const fileCount = {{ file_count|default(0) }};
        const sizeMb = {{ size_mb|default(0) }};
        let totalStats = { 
            tokens: 0, 
            inputTokens: 0, 
            outputTokens: 0, 
            cost: 0, 
            iterations: 0, 
            time: 0 
        };
        let analysisInProgress = false;

        // Toggle message expansion - Claude style (always expanded by default)
        function toggleMessage(header) {
            const content = header.nextElementSibling;
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
            }
        }

        // Auto-expand welcome message on load
        document.addEventListener('DOMContentLoaded', function() {
            const welcomeHeader = document.querySelector('.message-header');
            const welcomeContent = welcomeHeader.nextElementSibling;
            
            welcomeContent.classList.add('expanded');
            welcomeHeader.classList.add('expanded');
            
            initializeEnvironment();
        });

        // Enhanced message function with API call tracking
        function addChatMessage(type, title, content, metadata = {}) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.id = messageId;
            
            const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Build API call info display
            let apiCallInfo = '';
            if (metadata.apiCall) {
                apiCallInfo += `<div class="api-call-info">API Call: ${metadata.apiCall.model || 'Unknown'}</div>`;
            }
            if (metadata.tokens) {
                apiCallInfo += `<div class="api-call-info token-info">
                    In: ${metadata.tokens.input || 0} | Out: ${metadata.tokens.output || 0}
                </div>`;
            }
            if (metadata.cost) {
                apiCallInfo += `<div class="api-call-info cost-info">$${metadata.cost.toFixed(4)}</div>`;
            }
            
            message.innerHTML = `
                <div class="message-bubble">
                    <div class="message-header" data-toggle="message">
                        <div class="message-title">
                            <i class="fas fa-${getMessageIcon(type)}"></i>
                            ${title}
                        </div>
                        <div class="message-meta">
                            <span>${timeStr}</span>
                            ${metadata.duration ? `<span>${metadata.duration}s</span>` : ''}
                            ${apiCallInfo}
                            <i class="fas fa-chevron-down expand-icon"></i>
                        </div>
                    </div>
                    <div class="message-content">
                        ${content}
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(message);
            
            // Auto-scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }

        // Get appropriate icon for message type
        function getMessageIcon(type) {
            const icons = {
                'user': 'user',
                'ai': 'robot',
                'system': 'cog',
                'chart': 'chart-bar',
                'debug': 'bug'
            };
            return icons[type] || 'comment';
        }

        // Debug mode functionality removed for simplicity

        // Add debug message function (simplified - always visible)
        function addDebugMessage(title, content, metadata = {}) {
            return addChatMessage('debug', title, content, metadata);
        }

        // Conversation input handlers
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResizeInput(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 192) + 'px'; // Max 12rem
            
            // Enable/disable send button
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = !textarea.value.trim();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage('user', 'Continue Analysis', message, {
                tokens: { input: 0, output: 0 },
                cost: 0
            });
            
            // Clear input
            input.value = '';
            autoResizeInput(input);
            
            // Process the message
            processUserMessage(message);
        }

        async function processUserMessage(message) {
            // This will be expanded to handle conversation flow
            try {
                // Processing message
                const processingId = addChatMessage('ai', 'Analyzing Request', 
                    '<div class="thinking-dots"><span></span><span></span><span></span></div> Understanding your request...');
                
                // Use the same model configuration as the analysis steps
                const modelConfig = {
                    provider: document.getElementById('modelProvider').value,
                    model: document.getElementById('modelName').value,
                    // Thinking mode parameters removed for simplicity
                };
                
                try {
                    // Make actual API call to continue analysis with same model
                    const response = await fetch('/api/chat/dataset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            dataset_ref: getDatasetRef(),
                            model_config: modelConfig
                        })
                    });
                    
                    const data = await response.json();
                    document.getElementById(processingId).remove();
                    
                    if (data.success) {
                        addChatMessage('ai', 'Analysis Response', data.response, {
                            apiCall: { model: `${modelConfig.provider}:${modelConfig.model}` },
                            tokens: { input: data.tokens_used?.input || 0, output: data.tokens_used?.output || 0 },
                            cost: data.cost || 0,
                            duration: data.response_time || 0
                        });
                    } else {
                        throw new Error(data.error || 'Failed to get response');
                    }
                } catch (error) {
                    document.getElementById(processingId).remove();
                    addChatMessage('ai', 'Error', 
                        `<div class="alert alert-danger">Failed to continue analysis: ${error.message}</div>`, {
                        apiCall: { model: `${modelConfig.provider}:${modelConfig.model}` },
                        tokens: { input: 0, output: 0 },
                        cost: 0,
                        duration: 0
                    });
                }
                
            } catch (error) {
                addChatMessage('system', 'Error', `<div class="error-item">Failed to process message: ${error.message}</div>`);
            }
        }

        // Add analysis step card
        function addAnalysisStep(stepNumber, title, status = 'pending') {
            const stepId = `step-${stepNumber}`;
            const statusIcons = {
                pending: 'clock',
                running: 'spinner fa-spin',
                completed: 'check-circle',
                error: 'exclamation-circle'
            };
            
            // Always expand by default - no more collapsing
            const stepCard = `
                <div class="analysis-step-card ${status} expanded" id="${stepId}">
                    <div class="step-header expanded">
                        <div class="step-title">
                            <i class="fas fa-${statusIcons[status]}"></i>
                            Step ${stepNumber}: ${title}
                        </div>
                        <div class="step-status">
                            <span class="status-badge ${status}">${status}</span>
                        </div>
                    </div>
                    <div class="message-content expanded" id="${stepId}-content" style="display: block; padding: 1rem;">
                        ${status === 'running' ? '<div class="thinking-dots"><span></span><span></span><span></span></div> Processing...' : 'Waiting to start...'}
                    </div>
                </div>
            `;
            
            return stepCard;
        }

        // Get dataset reference for API calls
        function getDatasetRef() {
            return "{{ dataset_ref }}";
        }

        // Modern real-time cost calculation based on current model
        function calculateModelCost(provider, model, inputTokens, outputTokens) {
            // Updated pricing as of 2025 (per 1M tokens)
            const pricing = {
                'gemini-1.5-flash-8b': { input: 0.0375, output: 0.15 },        // $0.0375/$0.15 per 1M
                'gemini-2.5-pro': { input: 3.5, output: 10.5 },               // $3.50/$10.50 per 1M  
                'gemini-2.5-flash': { input: 0.075, output: 0.3 },            // $0.075/$0.30 per 1M
                'gemini-1.5-pro': { input: 1.25, output: 5.0 },               // $1.25/$5.00 per 1M
                'gemini-1.5-flash': { input: 0.075, output: 0.3 },            // $0.075/$0.30 per 1M
                'claude-opus-4-20250514': { input: 15.0, output: 75.0 },      // $15/$75 per 1M
                'claude-sonnet-4-20250514': { input: 3.0, output: 15.0 },     // $3/$15 per 1M
                'claude-3-5-sonnet-20241022': { input: 3.0, output: 15.0 },   // $3/$15 per 1M
                'claude-3-5-haiku-20241022': { input: 0.25, output: 1.25 },   // $0.25/$1.25 per 1M
                'claude-3-opus-20240229': { input: 15.0, output: 75.0 }       // $15/$75 per 1M
            };
            
            const modelPricing = pricing[model] || pricing['gemini-1.5-flash-8b']; // fallback
            const inputCost = (inputTokens / 1_000_000) * modelPricing.input;
            const outputCost = (outputTokens / 1_000_000) * modelPricing.output;
            
            return inputCost + outputCost;
        }

        // Real-time stats update with smooth animations
        function updateStats(newInputTokens = 0, newOutputTokens = 0, newIterations = 0, newTime = 0) {
            // Get current model for accurate pricing
            const provider = document.getElementById('modelProvider').value;
            const model = document.getElementById('modelName').value;
            
            // Calculate cost for new tokens
            const newCost = calculateModelCost(provider, model, newInputTokens, newOutputTokens);
            const newTotalTokens = newInputTokens + newOutputTokens;
            
            // Update totals
            totalStats.inputTokens = (totalStats.inputTokens || 0) + newInputTokens;
            totalStats.outputTokens = (totalStats.outputTokens || 0) + newOutputTokens;
            totalStats.tokens = (totalStats.inputTokens || 0) + (totalStats.outputTokens || 0);
            totalStats.cost += newCost;
            totalStats.iterations += newIterations;
            totalStats.time += newTime;
            
            // Animate the updates with modern CSS transitions
            animateStatUpdate('totalTokens', totalStats.tokens.toLocaleString());
            animateStatUpdate('totalCost', `$${totalStats.cost.toFixed(4)}`);
            animateStatUpdate('totalIterations', totalStats.iterations);
            animateStatUpdate('totalTime', `${totalStats.time.toFixed(1)}s`);
            
            // Show detailed token breakdown on hover
            updateTokenBreakdown();
        }

        // Smooth animation for stat updates
        function animateStatUpdate(elementId, newValue) {
            const element = document.getElementById(elementId);
            const oldValue = element.textContent;
            
            if (oldValue !== newValue) {
                // Add pulse animation for visual feedback
                element.style.transform = 'scale(1.1)';
                element.style.color = '#10b981'; // Success green
                element.textContent = newValue;
                
                // Reset animation after short delay
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                    element.style.color = '#4f46e5'; // Back to primary color
                }, 300);
            }
        }

        // Update token breakdown display
        function updateTokenBreakdown() {
            const tokensElement = document.getElementById('totalTokens');
            const breakdownElement = document.getElementById('tokenBreakdown');
            const modelInfoElement = document.getElementById('modelInfo');
            const inputTokens = totalStats.inputTokens || 0;
            const outputTokens = totalStats.outputTokens || 0;
            
            // Update tooltip
            tokensElement.title = `Input: ${inputTokens.toLocaleString()} | Output: ${outputTokens.toLocaleString()}`;
            
            // Update visible breakdown
            breakdownElement.textContent = `Input: ${inputTokens.toLocaleString()} | Output: ${outputTokens.toLocaleString()}`;
            
            // Update model info
            const provider = document.getElementById('modelProvider').value;
            const model = document.getElementById('modelName').value;
            const modelName = model.replace('gemini-', '').replace('claude-', '').replace('-20250514', '').replace('-20241022', '').replace('-20240229', '');
            modelInfoElement.textContent = `${provider.charAt(0).toUpperCase() + provider.slice(1)} ${modelName}`;
        }

        // Environment setup
        function initializeEnvironment() {
            
            // Model selection is now handled by model-selector.js component automatically
            
            // Add event listeners for model changes
            const providerSelect = document.getElementById('modelProvider');
            const modelSelect = document.getElementById('modelName');
            
            if (providerSelect) {
                providerSelect.addEventListener('change', updateTokenBreakdown);
            }
            if (modelSelect) {
                modelSelect.addEventListener('change', function() {
                    updateTokenBreakdown();
                    // Thinking visibility update removed
                });
            }
            
            // Debug mode functionality removed
            
            // Add event listeners for buttons
            const startAnalysisBtn = document.getElementById('startAnalysis');
            if (startAnalysisBtn) {
                startAnalysisBtn.addEventListener('click', startAnalysis);
            }
            
            const clearChatBtn = document.getElementById('clearChatBtn');
            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', clearChat);
            }
            
            const goBackBtn = document.getElementById('goBackBtn');
            if (goBackBtn) {
                goBackBtn.addEventListener('click', goBack);
            }
            
            const regenerateBtn = document.getElementById('regenerateBtn');
            if (regenerateBtn) {
                regenerateBtn.addEventListener('click', regenerateAnalysis);
            }
            
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
            
            // Add event listeners for dynamic content (delegate to handle dynamic content)
            document.addEventListener('click', function(event) {
                // Message headers
                if (event.target.closest('[data-toggle="message"]')) {
                    toggleMessage(event.target.closest('[data-toggle="message"]'));
                }
                
                // Plot headers
                if (event.target.closest('[data-toggle="plot"]')) {
                    const plotHeader = event.target.closest('[data-toggle="plot"]');
                    const plotId = plotHeader.getAttribute('data-plot-id');
                    if (plotId) {
                        togglePlot(plotId);
                    }
                }
            });
        }

        // Model selection is now handled by the reusable model-selector.js component
        // Component provides: updateAvailableModels(), getCurrentModelConfig()
        
        // updateThinkingBudget() and updateBudgetDisplay() functions removed - thinking mode disabled

        // Start analysis
        async function startAnalysis() {
            if (analysisInProgress) return;
            
            // Check if selected model is disabled in production
            const modelSelect = document.getElementById('modelName');
            const selectedOption = modelSelect.options[modelSelect.selectedIndex];
            if (selectedOption && selectedOption.disabled) {
                alert('This model is not available in production. Please select an available model or contact your administrator for premium access.');
                return;
            }
            
            analysisInProgress = true;
            const startBtn = document.getElementById('startAnalysis');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            
            // Reset stats
            totalStats = { 
                tokens: 0, 
                inputTokens: 0, 
                outputTokens: 0, 
                cost: 0, 
                iterations: 0, 
                time: 0 
            };
            updateStats(0, 0, 0, 0);
            
            // Add user message
            addChatMessage('user', 'Start Dataset Analysis', `Please analyze the dataset <strong>${datasetRef}</strong> using the selected AI model. Provide comprehensive insights, visualizations, and recommendations.`);
            
            // Add analysis steps
            const steps = [
                'Comprehensive Data Analysis',
                'Advanced Statistical Analysis', 
                'Machine Learning Analysis',
                'AI Insights & Recommendations'
            ];
            
            let stepsContent = '<div class="mt-3">';
            steps.forEach((title, index) => {
                stepsContent += addAnalysisStep(index + 1, title);
            });
            stepsContent += '</div>';
            
            addChatMessage('ai', 'Analysis Plan', `I'll analyze your dataset in ${steps.length} comprehensive steps:${stepsContent}`);
            
            // Run analysis steps
            try {
                for (let i = 0; i < steps.length; i++) {
                    await runAnalysisStep(i + 1, steps[i]);
                }
                
                // Complete
                addChatMessage('ai', 'Analysis Complete', 
                    '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Dataset analysis completed successfully! You can now ask for more visualizations, deeper analysis, or specific insights about your dataset.</div>');
                
                // Load debug messages if debug mode is enabled and we have a conversation ID
                if (window.lastConversationId) {
                    console.log(`Loading all debug messages for conversation: ${window.lastConversationId}`);
                    await loadAllDebugMessages(window.lastConversationId);
                }
                
                startBtn.innerHTML = '<i class="fas fa-check"></i> Analysis Complete';
                document.getElementById('regenerateBtn').style.display = 'inline-block';
                
                // Show conversation input for continued analysis
                document.getElementById('actionButtons').style.display = 'none';
                document.getElementById('conversationInput').style.display = 'block';
                
            } catch (error) {
                addChatMessage('ai', 'Analysis Failed', 
                    `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Analysis failed: ${error.message}</div>`);
                
                startBtn.innerHTML = '<i class="fas fa-play"></i> Retry Analysis';
                startBtn.disabled = false;
            }
            
            analysisInProgress = false;
        }

        // Run individual analysis step
        async function runAnalysisStep(stepNumber, description) {
            const stepId = `step-${stepNumber}`;
            const stepCard = document.getElementById(stepId);
            const stepContent = document.getElementById(`${stepId}-content`);
            
            // Update step to running
            stepCard.className = 'analysis-step-card running';
            stepCard.querySelector('.status-badge').textContent = 'running';
            stepCard.querySelector('.status-badge').className = 'status-badge running';
            stepCard.querySelector('.step-title i').className = 'fas fa-spinner fa-spin';
            stepContent.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div> Processing...';
            
            try {
                const modelConfig = {
                    provider: document.getElementById('modelProvider').value,
                    model: document.getElementById('modelName').value,
                    iterative_mode: true,
                    max_iterations: 5
                };
                
                // Thinking parameters removed for simplicity
                
                const response = await fetch('/api/datasets/analyze/step', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dataset_ref: datasetRef,
                        step: stepNumber,
                        description: description,
                        model_config: modelConfig
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`Step ${stepNumber} completed successfully. Result:`, data.result);
                    
                    // Update stats from iterations with real-time tracking FIRST
                    if (data.result.iterations) {
                        data.result.iterations.forEach(iteration => {
                            const inputTokens = iteration.prompt_tokens || 0;
                            const outputTokens = iteration.completion_tokens || 0;
                            const time = (iteration.generation_time || 0) + (iteration.execution_time || 0);
                            
                            // Use real-time cost calculation
                            updateStats(inputTokens, outputTokens, 1, time);
                        });
                    }
                    
                    // Store conversation_id for later debug loading
                    if (data.result.conversation_id) {
                        console.log(`Found conversation_id: ${data.result.conversation_id} for step ${stepNumber}`);
                        window.lastConversationId = data.result.conversation_id;
                    } else {
                        console.log(`No conversation_id found in response for step ${stepNumber}`);
                    }
                    
                    // Update step to completed
                    stepCard.className = 'analysis-step-card completed';
                    stepCard.querySelector('.status-badge').textContent = 'completed';
                    stepCard.querySelector('.status-badge').className = 'status-badge completed';
                    stepCard.querySelector('.step-title i').className = 'fas fa-check-circle';
                    
                    // SIMPLIFIED APPROACH: Just dump everything in order
                    let fullContent = '';
                    
                    // 1. CONVERSATION SECTION (Main output)
                    fullContent += '<div class="mb-4">';
                    fullContent += '<h4><i class="fas fa-comments text-primary me-2"></i>Analysis Results</h4>';
                    if (data.result.output) {
                        fullContent += '<div class="border rounded p-3 bg-light">';
                        fullContent += '<pre style="white-space: pre-wrap; font-family: system-ui; font-size: 0.9em; line-height: 1.4;">' + escapeHtml(data.result.output) + '</pre>';
                        fullContent += '</div>';
                    }
                    fullContent += '</div>';
                    
                    // 2. DEBUG LOGS SECTION (Iterations/Debug info)
                    if (data.result.iterations && data.result.iterations.length > 0) {
                        fullContent += '<div class="mb-4">';
                        fullContent += '<h4><i class="fas fa-bug text-warning me-2"></i>Debug Logs (' + data.result.iterations.length + ' iterations)</h4>';
                        fullContent += '<div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background: #f8f9fa;">';
                        
                        data.result.iterations.forEach((iteration, index) => {
                            fullContent += `<div class="mb-3 border-bottom pb-2">`;
                            fullContent += `<strong>Iteration ${iteration.iteration || index + 1}:</strong> `;
                            fullContent += `<span class="badge ${iteration.success ? 'bg-success' : 'bg-danger'} me-2">${iteration.success ? 'Success' : 'Failed'}</span>`;
                            fullContent += `<small class="text-muted">${iteration.generation_time || 0}s generation, ${iteration.execution_time || 0}s execution</small><br>`;
                            
                            if (iteration.execution_result) {
                                fullContent += `<div class="mt-2"><small class="text-muted">Output:</small><br>`;
                                fullContent += `<pre style="font-size: 0.8em; max-height: 200px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px;">${escapeHtml(iteration.execution_result)}</pre></div>`;
                            }
                            if (iteration.error_message) {
                                fullContent += `<div class="mt-2"><small class="text-danger">Error:</small><br>`;
                                fullContent += `<pre style="font-size: 0.8em; color: red; background: #ffe6e6; padding: 8px; border-radius: 4px;">${escapeHtml(iteration.error_message)}</pre></div>`;
                            }
                            fullContent += `</div>`;
                        });
                        
                        fullContent += '</div>';
                        fullContent += '</div>';
                    }
                    
                    // 3. CHARTS/PLOTS SECTION (Extract plot info and show files)
                    console.log('FIGURE_DIKHA_001: Starting plot extraction from output');
                    if (data.result.output) {
                        console.log('FIGURE_DIKHA_002: Output exists, searching for PLOT_INFO blocks');
                        const plotMatches = data.result.output.match(/PLOT_INFO_START([\s\S]*?)PLOT_INFO_END/g);
                        console.log('FIGURE_DIKHA_003: Plot matches found:', plotMatches ? plotMatches.length : 0);
                        if (plotMatches && plotMatches.length > 0) {
                            fullContent += '<div class="mb-4">';
                            fullContent += '<h4><i class="fas fa-chart-bar text-success me-2"></i>Generated Charts (' + plotMatches.length + ' plots)</h4>';
                            
                            plotMatches.forEach((plotBlock, index) => {
                                console.log(`FIGURE_DIKHA_004: Processing plot ${index + 1}:`, plotBlock);
                                const plotInfo = plotBlock.replace(/PLOT_INFO_START|PLOT_INFO_END/g, '').trim();
                                const lines = plotInfo.split('\n');
                                
                                let title = 'Chart ' + (index + 1);
                                let description = '';
                                let filename = '';
                                let insights = '';
                                
                                lines.forEach(line => {
                                    if (line.startsWith('title:')) title = line.replace('title:', '').trim();
                                    if (line.startsWith('description:')) description = line.replace('description:', '').trim();
                                    if (line.startsWith('filename:')) filename = line.replace('filename:', '').trim();
                                    if (line.startsWith('key_insights:')) insights = line.replace('key_insights:', '').trim();
                                });
                                
                                console.log(`FIGURE_DIKHA_005: Parsed plot info - Title: "${title}", Filename: "${filename}", Description: "${description}"`);
                                
                                fullContent += `<div class="card mb-3">`;
                                fullContent += `<div class="card-header bg-success text-white"><strong><i class="fas fa-chart-line me-2"></i>${title}</strong></div>`;
                                fullContent += `<div class="card-body">`;
                                if (description) fullContent += `<p><strong><i class="fas fa-info-circle me-1"></i>Description:</strong> ${description}</p>`;
                                if (filename) {
                                    console.log(`FIGURE_DIKHA_006: Attempting to display image: "${filename}"`);
                                    fullContent += `<p><strong><i class="fas fa-file me-1"></i>File:</strong> <code>${filename}</code></p>`;
                                    // Try to display the actual image
                                    fullContent += `<div class="text-center mb-3">`;
                                    const imageUrl = `/api/dataset-image/${filename}`;
                                    console.log(`FIGURE_DIKHA_007: Image URL constructed: "${imageUrl}"`);
                                    fullContent += `<img src="${imageUrl}" class="img-fluid" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px;" `;
                                    fullContent += `onload="console.log('FIGURE_DIKHA_008: Image loaded successfully: ${filename}')" `;
                                    fullContent += `onerror="console.log('FIGURE_DIKHA_009: Image failed to load: ${filename}'); this.style.display='none'; this.nextElementSibling.style.display='block';" />`;
                                    fullContent += `<div class="alert alert-warning" style="display: none;"><i class="fas fa-exclamation-triangle me-2"></i>Image file "${filename}" not found or could not be loaded.</div>`;
                                    fullContent += `</div>`;
                                } else {
                                    console.log('FIGURE_DIKHA_010: No filename found for this plot');
                                }
                                if (insights) fullContent += `<p><strong><i class="fas fa-lightbulb me-1"></i>Key Insights:</strong> ${insights}</p>`;
                                fullContent += `</div>`;
                                fullContent += `</div>`;
                            });
                            
                            fullContent += '</div>';
                            console.log('FIGURE_DIKHA_011: Charts section added to content');
                            
                            // Debug: Check what images are available
                            fetch('/api/list-dataset-images')
                                .then(response => response.json())
                                .then(imageList => {
                                    console.log('FIGURE_DIKHA_014: Available images on server:', imageList);
                                })
                                .catch(error => {
                                    console.log('FIGURE_DIKHA_015: Error checking available images:', error);
                                });
                        } else {
                            console.log('FIGURE_DIKHA_012: No plot matches found in output');
                        }
                    } else {
                        console.log('FIGURE_DIKHA_013: No output data available for plot extraction');
                    }
                    
                    // 4. INSIGHTS SECTION (if available)
                    if (data.result.insights && data.result.insights.length > 0) {
                        fullContent += '<div class="mb-4">';
                        fullContent += '<h4><i class="fas fa-lightbulb text-warning me-2"></i>Key Insights</h4>';
                        fullContent += '<div class="list-group">';
                        data.result.insights.forEach(insight => {
                            fullContent += `<div class="list-group-item"><i class="fas fa-arrow-right me-2 text-primary"></i>${insight}</div>`;
                        });
                        fullContent += '</div>';
                        fullContent += '</div>';
                    }
                    
                    // 5. SUMMARY SECTION
                    fullContent += '<div class="mb-4">';
                    fullContent += '<h4><i class="fas fa-clipboard-check text-info me-2"></i>Summary</h4>';
                    fullContent += '<div class="row">';
                    fullContent += `<div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${data.result.iterations_used || 'N/A'}</h5><small>Iterations Used</small></div></div></div>`;
                    fullContent += `<div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${data.result.files_analyzed || 'N/A'}</h5><small>Files Analyzed</small></div></div></div>`;
                    fullContent += `<div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${data.result.model_used || 'N/A'}</h5><small>Model Used</small></div></div></div>`;
                    fullContent += `<div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>$${(data.result.cost_estimate || 0).toFixed(4)}</h5><small>Est. Cost</small></div></div></div>`;
                    fullContent += '</div>';
                    fullContent += '</div>';
                    
                    stepContent.innerHTML = fullContent;
                    
                } else {
                    throw new Error(data.error?.message || 'Step failed');
                }
                
            } catch (error) {
                // Update step to error
                stepCard.className = 'analysis-step-card error';
                stepCard.querySelector('.status-badge').textContent = 'error';
                stepCard.querySelector('.status-badge').className = 'status-badge error';
                stepCard.querySelector('.step-title i').className = 'fas fa-exclamation-circle';
                stepContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                
                throw error;
            }
        }

        // Utility functions
        function clearChat() {
            if (confirm('Are you sure you want to clear the chat?')) {
                location.reload();
            }
        }

        function goBack() {
            window.history.back();
        }

        function regenerateAnalysis() {
            if (confirm('Regenerate the analysis? This will clear current results.')) {
                location.reload();
            }
        }

        function toggleStep(stepId) {
            const stepCard = document.getElementById(stepId);
            const content = stepCard.querySelector('.message-content');
            const header = stepCard.querySelector('.step-header');
            
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                stepCard.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                stepCard.classList.add('expanded');
            }
        }

        // Format analysis output into beautiful, structured content
        function formatAnalysisOutput(rawOutput, stepNumber) {
            const stepTitles = {
                1: '<i class="fas fa-database"></i>Data Loading & Overview',
                2: '<i class="fas fa-chart-bar"></i>Statistical Analysis',
                3: '<i class="fas fa-columns"></i>Column Analysis',
                4: '<i class="fas fa-brain"></i>AI Insights & Recommendations'
            };

            let formatted = `<div class="analysis-results">`;
            formatted += `<h3>${stepTitles[stepNumber] || 'Analysis Results'}</h3>`;

            // Parse the raw output and structure it
            const lines = rawOutput.split('\n');
            let currentSection = '';
            let tableData = [];
            let inTable = false;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Skip file path lines
                if (line.startsWith('File ') || line.startsWith('Main file:')) continue;

                // Success indicators
                if (line.includes('✅ Data loaded successfully')) {
                    const match = line.match(/✅ Data loaded successfully: \((\d+), (\d+)\)/);
                    if (match) {
                        formatted += `<div class="stats-grid">`;
                        formatted += `<div class="stat-card">`;
                        formatted += `<div class="label">Rows</div>`;
                        formatted += `<div class="value">${parseInt(match[1]).toLocaleString()}</div>`;
                        formatted += `</div>`;
                        formatted += `<div class="stat-card">`;
                        formatted += `<div class="label">Columns</div>`;
                        formatted += `<div class="value">${match[2]}</div>`;
                        formatted += `</div>`;
                        formatted += `</div>`;
                    }
                    continue;
                }

                // Section headers
                if (line.includes('Data Types:') || line.includes('Basic Statistics:') || 
                    line.includes('Descriptive Statistics:') || line.includes('Missing values:') ||
                    line.includes('Species Distribution:') || line.includes('Distribution Analysis')) {
                    if (inTable && tableData.length > 0) {
                        formatted += createDataTable(tableData);
                        tableData = [];
                        inTable = false;
                    }
                    currentSection = line.replace(':', '');
                    formatted += `<h4>${currentSection}</h4>`;
                    continue;
                }

                // Handle tabular data
                if (line.includes('count') && line.includes('mean') && line.includes('std')) {
                    inTable = true;
                    tableData = [['Statistic', 'sepal_length', 'sepal_width', 'petal_length', 'petal_width']];
                    continue;
                }

                if (inTable && (line.includes('count') || line.includes('mean') || line.includes('std') || 
                               line.includes('min') || line.includes('25%') || line.includes('50%') || 
                               line.includes('75%') || line.includes('max'))) {
                    const parts = line.split(/\s+/);
                    if (parts.length >= 5) {
                        tableData.push(parts);
                    }
                    continue;
                }

                // Handle data types
                if (line.includes('float64') || line.includes('object') || line.includes('int64')) {
                    if (!inTable) {
                        inTable = true;
                        tableData = [['Column', 'Data Type']];
                    }
                    const parts = line.split(/\s+/);
                    if (parts.length >= 2) {
                        tableData.push([parts[0], parts[1]]);
                    }
                    continue;
                }

                // Handle missing values
                if (currentSection.includes('Missing values') && line.includes('0')) {
                    if (!inTable) {
                        formatted += `<div class="insight-item">✅ No missing values found in any column</div>`;
                    }
                    continue;
                }

                // Handle species distribution
                if (line.includes('Iris-setosa') || line.includes('Iris-versicolor') || line.includes('Iris-virginica')) {
                    if (!inTable) {
                        inTable = true;
                        tableData = [['Species', 'Count']];
                    }
                    const parts = line.split(/\s+/);
                    if (parts.length >= 2) {
                        tableData.push([parts[0], parts[1]]);
                    }
                    continue;
                }

                // Handle errors and warnings
                if (line.includes('❌') || line.includes('Error:')) {
                    formatted += `<div class="error-item"><i class="fas fa-exclamation-triangle me-2"></i>${line}</div>`;
                    continue;
                }

                // Handle validation errors
                if (line.includes('Validation Error:')) {
                    formatted += `<div class="warning-item"><i class="fas fa-exclamation-triangle me-2"></i>${line}</div>`;
                    continue;
                }

                // Handle duplicate rows
                if (line.includes('Duplicate Rows:')) {
                    formatted += `<h4>Data Quality</h4>`;
                    formatted += `<div class="warning-item"><i class="fas fa-copy me-2"></i>Duplicate rows detected in the dataset</div>`;
                    continue;
                }

                // General information lines
                if (line && !line.includes('Loading data from:') && !line.includes('dtype:')) {
                    formatted += `<p>${line}</p>`;
                }
            }

            // Add any remaining table data
            if (inTable && tableData.length > 0) {
                formatted += createDataTable(tableData);
            }

            formatted += `</div>`;
            return formatted;
        }

        // Create a formatted data table
        function createDataTable(data) {
            if (data.length === 0) return '';
            
            let table = `<div class="data-table"><table>`;
            
            // Header row
            table += `<thead><tr>`;
            for (let header of data[0]) {
                table += `<th>${header}</th>`;
            }
            table += `</tr></thead>`;
            
            // Data rows
            table += `<tbody>`;
            for (let i = 1; i < data.length; i++) {
                table += `<tr>`;
                for (let j = 0; j < data[i].length; j++) {
                    let cellValue = data[i][j];
                    // Format numbers nicely
                    if (!isNaN(cellValue) && cellValue !== '') {
                        cellValue = parseFloat(cellValue).toLocaleString(undefined, {maximumFractionDigits: 6});
                    }
                    table += `<td>${cellValue}</td>`;
                }
                table += `</tr>`;
            }
            table += `</tbody></table></div>`;
            
            return table;
        }

        // Load all conversation debug messages and add them to chat in chronological order
        async function loadAllDebugMessages(conversationId) {
            try {
                console.log(`Loading all debug messages for conversation ${conversationId}`);
                const response = await fetch(`/api/datasets/conversation/${conversationId}`);
                if (!response.ok) {
                    console.log(`Failed to fetch conversation: ${response.status}`);
                    return;
                }
                
                const data = await response.json();
                console.log(`Conversation data:`, data);
                
                if (!data.success || !data.messages) {
                    console.log(`No messages found or request failed`);
                    return;
                }
                
                // Sort messages by timestamp to ensure chronological order
                const sortedMessages = data.messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                
                // Group messages by step for better titles
                const messagesByStep = {};
                sortedMessages.forEach(message => {
                    const step = message.step || 1;
                    if (!messagesByStep[step]) messagesByStep[step] = [];
                    messagesByStep[step].push(message);
                });
                
                // Process messages and add debug content chronologically to main chat
                let globalIndex = 0;
                Object.keys(messagesByStep).sort((a, b) => parseInt(a) - parseInt(b)).forEach(stepKey => {
                    const stepMessages = messagesByStep[stepKey];
                    const stepNumber = parseInt(stepKey);
                    
                    stepMessages.forEach((message, stepIndex) => {
                        const messageTitle = getDebugMessageTitle(message, stepIndex, stepNumber);
                        const messageContent = formatDebugMessage(message);
                        
                        // Extract tokens from conversation data properly
                        const tokens = extractTokensFromMessage(message);
                        const model = extractModelFromMessage(message);
                        const cost = calculateDebugCostFromMessage(message, tokens, model);
                        
                        // Add as regular debug message to chat
                        addDebugMessage(messageTitle, messageContent, {
                            apiCall: { model: model },
                            tokens: tokens,
                            cost: cost,
                            duration: message.generation_time || message.duration || 0
                        });
                        
                        globalIndex++;
                    });
                });
                
                console.log(`Added ${sortedMessages.length} debug messages in chronological order`);
                
            } catch (error) {
                console.error('Failed to load debug messages:', error);
            }
        }

        // Get debug message title
        function getDebugMessageTitle(message, index, stepNumber) {
            const stepPrefix = `Step ${stepNumber}`;
            
            if (message.role === 'user') {
                return `${stepPrefix} - System Prompt ${Math.floor(index/2) + 1}`;
            } else if (message.role === 'assistant') {
                return `${stepPrefix} - LLM Response ${Math.floor(index/2) + 1}`;
            } else {
                return `${stepPrefix} - Debug Message ${index + 1}`;
            }
        }

        // Format debug message content
        function formatDebugMessage(message) {
            let content = `<div class="debug-message-content">`;
            
            // Message role and metadata
            content += `<div class="mb-3">`;
            content += `<strong>Role:</strong> ${message.role} | `;
            content += `<strong>Type:</strong> ${message.message_type || 'Unknown'} | `;
            content += `<strong>Timestamp:</strong> ${new Date(message.timestamp).toLocaleTimeString()}`;
            content += `</div>`;
            
            // Message content
            if (message.content) {
                content += `<div class="mb-3">`;
                content += `<h6><i class="fas fa-comment-alt me-2"></i>Message Content:</h6>`;
                content += `<div class="code-snippet">${escapeHtml(message.content)}</div>`;
                content += `</div>`;
            }
            
            // Code if present
            if (message.code) {
                content += `<div class="mb-3">`;
                content += `<h6><i class="fas fa-code me-2"></i>Generated Code:</h6>`;
                content += `<div class="code-snippet">${escapeHtml(message.code)}</div>`;
                content += `</div>`;
            }
            
            // Execution result if present
            if (message.execution_result) {
                content += `<div class="mb-3">`;
                content += `<h6><i class="fas fa-terminal me-2"></i>Execution Output:</h6>`;
                content += `<div class="code-snippet">${escapeHtml(message.execution_result)}</div>`;
                content += `</div>`;
            }
            
            // Error message if present
            if (message.error_message) {
                content += `<div class="mb-3">`;
                content += `<h6><i class="fas fa-exclamation-triangle me-2"></i>Error:</h6>`;
                content += `<div class="error-item">${escapeHtml(message.error_message)}</div>`;
                content += `</div>`;
            }
            
            content += `</div>`;
            return content;
        }

        // Extract tokens from conversation message data
        function extractTokensFromMessage(message) {
            // Check various possible token locations in the message
            if (message.tokens) {
                return {
                    input: message.tokens.input || message.tokens.prompt_tokens || 0,
                    output: message.tokens.output || message.tokens.completion_tokens || 0
                };
            }
            
            // Check metadata for token information
            if (message.metadata) {
                const meta = message.metadata;
                return {
                    input: meta.prompt_tokens || meta.input_tokens || 0,
                    output: meta.completion_tokens || meta.output_tokens || 0
                };
            }
            
            // Default to zero
            return { input: 0, output: 0 };
        }
        
        // Extract model information from message
        function extractModelFromMessage(message) {
            // Check various possible model locations
            if (message.model) return message.model;
            if (message.model_used) return message.model_used;
            if (message.metadata && message.metadata.model) return message.metadata.model;
            if (message.metadata && message.metadata.model_used) return message.metadata.model_used;
            
            // Get from current UI selection as fallback
            const provider = document.getElementById('modelProvider').value;
            const model = document.getElementById('modelName').value;
            return `${provider}:${model}`;
        }
        
        // Calculate cost for debug message with proper model detection
        function calculateDebugCostFromMessage(message, tokens, model) {
            if (!tokens || (!tokens.input && !tokens.output)) return 0;
            
            // Parse provider and model from model string
            let provider, modelName;
            if (model && model.includes(':')) {
                [provider, modelName] = model.split(':');
            } else {
                provider = document.getElementById('modelProvider').value;
                modelName = document.getElementById('modelName').value;
            }
            
            return calculateModelCost(provider, modelName, tokens.input || 0, tokens.output || 0);
        }
        

        // Extract and render plots from output
        function extractAndRenderPlots(output, stepNumber) {
            const plotRegex = /PLOT_INFO_START\s*([\s\S]*?)\s*PLOT_INFO_END/g;
            let plotsHtml = '';
            let match;
            
            while ((match = plotRegex.exec(output)) !== null) {
                const plotInfo = parsePlotInfo(match[1]);
                if (plotInfo) {
                    plotsHtml += createPlotVisualization(plotInfo, stepNumber);
                }
            }
            
            return plotsHtml;
        }
        
        // Parse plot information from text
        function parsePlotInfo(infoText) {
            const lines = infoText.split('\n');
            const info = {};
            
            lines.forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parts.slice(1).join(':').trim();
                    info[key] = value;
                }
            });
            
            return info.title ? info : null;
        }
        
        // Create plot visualization HTML
        function createPlotVisualization(plotInfo, stepNumber) {
            const plotId = `plot-${stepNumber}-${Date.now()}`;
            
            return `
                <div class="plot-container" id="${plotId}">
                    <div class="plot-header" data-toggle="plot" data-plot-id="${plotId}">
                        <div class="plot-title">
                            <i class="fas fa-chart-bar me-2"></i>
                            ${plotInfo.title || 'Visualization'}
                        </div>
                        <div>
                            <i class="fas fa-chevron-down expand-icon"></i>
                        </div>
                    </div>
                    <div class="plot-content" id="${plotId}-content">
                        <div class="plot-description">
                            ${plotInfo.description || 'Data visualization'}
                        </div>
                        <div class="text-center">
                            <div class="alert alert-info">
                                <i class="fas fa-image me-2"></i>
                                Plot saved as: <strong>${plotInfo.filename || 'plot.png'}</strong>
                                <br><small>Visualization rendered locally - future versions will display inline</small>
                            </div>
                        </div>
                        ${plotInfo.key_insights ? `
                            <div class="plot-insights">
                                <h6><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                                <p>${plotInfo.key_insights}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Toggle plot visibility
        function togglePlot(plotId) {
            const content = document.getElementById(`${plotId}-content`);
            const header = document.querySelector(`#${plotId} .plot-header`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.querySelector('.expand-icon').style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('expanded');
                header.querySelector('.expand-icon').style.transform = 'rotate(180deg)';
            }
        }

        // Escape HTML for safe display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>