{% extends "base.html" %}

{% block extra_css %}
<style>
    .placeholder-box {border:2px dashed #888; padding:2rem; text-align:center; border-radius:12px; background: #1d1f27; color:#ccc;}
    /* Dark theme readability fixes */
    .card.bg-dark, .card.bg-dark .card-header { color: #e6e6e6; }
    .bg-dark .form-label, .bg-dark label, .bg-dark .form-check-label, .bg-dark .form-text { color: #e6e6e6; }
    .bg-dark .form-control, .bg-dark .form-select { 
        background-color: #2a2f3a; 
        color: #eaeaea; 
        border-color: #444; 
    }
    .bg-dark .form-control::placeholder, .bg-dark .form-select option { color: #b7bdc8; }
    .bg-dark .form-control:focus, .bg-dark .form-select:focus { 
        background-color: #2d3340; 
        color: #ffffff; 
        border-color: #6c8cff; 
        box-shadow: 0 0 0 0.1rem rgba(108, 140, 255, 0.25);
    }
    /* Ensure the main prompt textarea is readable in dark mode */
    #promptJson { background-color: #2a2f3a; color: #eaeaea; border-color: #444; }
    #promptJson::placeholder { color: #b7bdc8; }
</style>
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <a href="/" class="btn btn-link mb-3"><i class="fas fa-arrow-left"></i> Back</a>
    <h1 class="mb-3">AI Video Generation (Beta)</h1>
    <p class="text-muted">Configure Veo 3 parameters and paste a JSON array of prompts. We'll validate and generate videos.</p>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header">Studio Controls</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Model</label>
                            <select id="model" class="form-select">
                                <option value="veo-3.0-fast-generate-001" selected>veo-3.0-fast-generate-001 (fast)</option>
                                <option value="veo-3.0-generate-001">veo-3.0-generate-001 (quality)</option>
                                <option value="veo-3.0-generate-preview">veo-3.0-generate-preview</option>
                                <option value="veo-3.0-fast-generate-preview">veo-3.0-fast-generate-preview</option>
                                <option value="veo-2.0-generate-001">veo-2.0-generate-001</option>
                                <option value="veo-2.0-generate-exp">veo-2.0-generate-exp</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Aspect Ratio</label>
                            <select id="aspectRatio" class="form-select">
                                <option value="16:9" selected>16:9</option>
                                <option value="9:16">9:16</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Duration</label>
                            <select id="durationSeconds" class="form-select">
                                <option value="4">4</option>
                                <option value="6">6</option>
                                <option value="8" selected>8</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Resolution (Veo 3)</label>
                            <select id="resolution" class="form-select">
                                <option value="">Default</option>
                                <option value="720p">720p</option>
                                <option value="1080p">1080p</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Compression</label>
                            <select id="compressionQuality" class="form-select">
                                <option value="">Default (optimized)</option>
                                <option value="optimized">optimized</option>
                                <option value="lossless">lossless</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Samples</label>
                            <select id="sampleCount" class="form-select">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Seed</label>
                            <input type="number" id="seed" class="form-control" placeholder="optional">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Negative Prompt</label>
                            <input type="text" id="negativePrompt" class="form-control" placeholder="optional">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Person Generation</label>
                            <select id="personGeneration" class="form-select">
                                <option value="">Default (allow_adult)</option>
                                <option value="allow_adult">allow_adult</option>
                                <option value="dont_allow">dont_allow</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enhancePrompt" checked>
                                <label class="form-check-label" for="enhancePrompt">Use prompt enhancement</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="generateAudio">
                                <label class="form-check-label" for="generateAudio">Generate audio (Veo 3)</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Storage URI (gs://bucket/prefix)</label>
                            <input type="text" id="storageUri" class="form-control" placeholder="optional">
                        </div>
                    </div>
                </div>
            </div>
            <label for="promptJson" class="form-label fw-semibold">Prompt JSON Input</label>
            <textarea id="promptJson" class="form-control" rows="14" placeholder='[\n  "A cat playing piano",\n  "A sunset over cyberpunk city"\n]'></textarea>
            <div class="d-flex gap-2 mt-3">
                <button id="validateBtn" class="btn btn-primary"><i class="fas fa-check"></i> Validate & Prepare</button>
                <button id="startBtn" class="btn btn-success d-none"><i class="fas fa-play"></i> Start Generation</button>
                <button id="loadSampleBtn" class="btn btn-outline-secondary"><i class="fas fa-paste"></i> Load Sample</button>
                <button id="clearBtn" class="btn btn-outline-danger"><i class="fas fa-eraser"></i> Clear</button>
            </div>
            <div id="errorBox" class="alert alert-danger mt-3 d-none small"></div>
            <div id="successBox" class="alert alert-success mt-3 d-none small"></div>
        </div>
        <div class="col-lg-7">
            <div id="tableContainer" class="d-none">
                <h5 class="mb-3">Prompt Batch</h5>
                <div class="table-responsive">
                    <table class="table table-dark table-sm align-middle" id="promptTable">
                        <thead>
                            <tr>
                                <th style="width:35%">Prompt</th>
                                <th style="width:12%">Status</th>
                                <th style="width:33%">Video / Preview</th>
                                <th style="width:20%">Path</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="placeholderPanel" class="placeholder-box mt-2">
                <p class="mb-2"><i class="fas fa-video fa-2x mb-3"></i></p>
                <h5 class="mb-3">Awaiting Valid Prompts</h5>
                <p class="mb-0">Enter a JSON array like:<br><code>["prompt1", "prompt2", "prompt3"]</code></p>
            </div>
        </div>
    </div>
</div>
<script>
    (function(){
        const promptInput = document.getElementById('promptJson');
    const validateBtn = document.getElementById('validateBtn');
    const startBtn = document.getElementById('startBtn');
        const loadSampleBtn = document.getElementById('loadSampleBtn');
        const clearBtn = document.getElementById('clearBtn');
        const errorBox = document.getElementById('errorBox');
        const successBox = document.getElementById('successBox');
        const tableContainer = document.getElementById('tableContainer');
        const placeholderPanel = document.getElementById('placeholderPanel');
        const promptTableBody = document.querySelector('#promptTable tbody');

    const sample = [
            "A cat playing piano in a jazz bar, cinematic lighting",
            "Slow orbital shot of a futuristic eco city at sunrise",
            "Drone flyover of terraced rice fields with morning mist"
        ];

        loadSampleBtn.addEventListener('click', () => {
            promptInput.value = JSON.stringify(sample, null, 2);
            hideMsg(errorBox); hideMsg(successBox);
        });

        clearBtn.addEventListener('click', () => {
            promptInput.value = '';
            promptTableBody.innerHTML = '';
            tableContainer.classList.add('d-none');
            placeholderPanel.classList.remove('d-none');
            hideMsg(errorBox); hideMsg(successBox);
        });

        function showMsg(el, html){ el.innerHTML = html; el.classList.remove('d-none'); }
        function hideMsg(el){ el.classList.add('d-none'); }

        function validatePrompts(raw){
            if(!raw || !raw.trim()) return { ok:false, reason:'Input is empty.' };
            let data;
            try { data = JSON.parse(raw); } catch(e){ return { ok:false, reason:'Invalid JSON: ' + e.message }; }
            if(!Array.isArray(data)) return { ok:false, reason:'JSON must be an array of strings.' };
            if(data.length === 0) return { ok:false, reason:'Array is empty. Provide at least one prompt.' };
            if(data.length > 50) return { ok:false, reason:'Too many prompts ('+data.length+'). Limit to 50 for now.' };
            for(let i=0;i<data.length;i++){
                if(typeof data[i] !== 'string' || !data[i].trim()){
                    return { ok:false, reason:`Element at index ${i} is not a non-empty string.` };
                }
                if(data[i].length > 400){
                    return { ok:false, reason:`Prompt at index ${i} exceeds 400 characters.` };
                }
            }
            return { ok:true, prompts:data };
        }

        let currentPrompts = [];
        let currentJobId = null;

        function renderTable(prompts){
            promptTableBody.innerHTML = '';
            prompts.forEach((p, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="small"><div class="text-wrap" style="white-space:pre-wrap;">${escapeHtml(p)}</div></td>
                    <td><span class="badge bg-secondary" id="status-${idx}">Pending</span></td>
                    <td>
                        <div class="video-slot" id="video-${idx}">
                            <div class="text-muted small">No video yet</div>
                        </div>
                    </td>
                    <td class="small" id="path-${idx}"><span class="text-muted">â€”</span></td>`;
                promptTableBody.appendChild(tr);
            });
            currentPrompts = prompts;
            startBtn.classList.remove('d-none');
        }

        function escapeHtml(str){
            return str.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]));
        }

        validateBtn.addEventListener('click', () => {
            hideMsg(errorBox); hideMsg(successBox);
            const result = validatePrompts(promptInput.value);
            if(!result.ok){
                showMsg(errorBox, `<strong>Invalid Input:</strong> ${result.reason}<br><br>Sample Format:<pre class='mb-0'>[\n  "prompt1",\n  "prompt2",\n  "prompt3"\n]</pre>`);
                return;
            }
            renderTable(result.prompts);
            placeholderPanel.classList.add('d-none');
            tableContainer.classList.remove('d-none');
            showMsg(successBox, `Validated ${result.prompts.length} prompt(s). Ready for generation.`);
        });

        startBtn.addEventListener('click', async () => {
            hideMsg(errorBox); hideMsg(successBox);
            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Starting...';
            try {
                const options = collectOptions();
                
                // Let the automatic CSRF protection handle the token
                const resp = await fetch('/api/video/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompts: currentPrompts, options })
                });
                const data = await resp.json();
                if(!data.success){
                    throw new Error(data.error || 'Failed to start job');
                }
                currentJobId = data.job_id;
                showMsg(successBox, 'Job started: ' + currentJobId);
                listenToStream(currentJobId);
            } catch(e){
                showMsg(errorBox, 'Error starting generation: ' + e.message);
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> Start Generation';
            }
        });

        function collectOptions(){
            const model = document.getElementById('model').value;
            const aspect_ratio = document.getElementById('aspectRatio').value;
            const duration_seconds = parseInt(document.getElementById('durationSeconds').value, 10);
            const resolution = document.getElementById('resolution').value || undefined;
            const compression_quality = document.getElementById('compressionQuality').value || undefined;
            const sample_count = parseInt(document.getElementById('sampleCount').value, 10) || 1;
            const seedVal = document.getElementById('seed').value;
            const seed = seedVal === '' ? undefined : Number(seedVal);
            const negative_prompt = document.getElementById('negativePrompt').value || undefined;
            const person_generation = document.getElementById('personGeneration').value || undefined;
            const enhance_prompt = document.getElementById('enhancePrompt').checked;
            const generate_audio = document.getElementById('generateAudio').checked ? true : undefined;
            const storage_uri = document.getElementById('storageUri').value || undefined;
            return { model, aspect_ratio, duration_seconds, resolution, compression_quality, sample_count, seed, negative_prompt, person_generation, enhance_prompt, generate_audio, storage_uri };
        }

        function listenToStream(jobId){
            const es = new EventSource(`/api/video/stream/${jobId}`);
            es.addEventListener('prompt.started', (ev) => {
                const d = JSON.parse(ev.data); const i = d.prompt_index; setStatus(i, 'Generating', 'info');
            });
            es.addEventListener('prompt.completed', (ev) => {
                const d = JSON.parse(ev.data); const i = d.prompt_index; setStatus(i, 'Completed', 'success');
                const slot = document.getElementById('video-' + i);
                const pathCell = document.getElementById('path-' + i);
                let displayPath = null;
                if(pathCell){
                    if(d.gcs_uris && d.gcs_uris.length){
                        displayPath = d.gcs_uris[0];
                    } else if(d.local_paths && d.local_paths.length){
                        displayPath = d.local_paths[0];
                    } else if(d.video_url){
                        displayPath = d.video_url;
                    }
                    if(displayPath) pathCell.textContent = displayPath;
                }
                if(d.video_url){
                    if(d.video_url.startsWith('gs://')){
                        slot.innerHTML = `<div class='text-muted small'>Stored in GCS</div>`;
                    } else {
                        // If it's a local filesystem-relative path (generated_videos/...), rewrite to /videos/ endpoint
                        let src = d.video_url;
                        if(!/^https?:\/\//.test(src) && !src.startsWith('/')){
                            // assume relative path under generated_videos
                            const rel = src.replace(/^generated_videos\/?/, '');
                            src = '/videos/' + rel;
                        }
                        slot.innerHTML = `<video src="${src}" controls style="max-width:100%; height:auto;"></video>`;
                    }
                }
            });
            es.addEventListener('prompt.failed', (ev) => {
                const d = JSON.parse(ev.data); const i = d.prompt_index; setStatus(i, 'Failed', 'danger');
            });
            es.addEventListener('job.completed', () => {
                showMsg(successBox, 'Job completed.');
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> Restart Generation';
            });
        }

        function setStatus(idx, text, color){
            const el = document.getElementById('status-' + idx);
            if(el){ el.className = 'badge bg-' + color; el.textContent = text; }
        }
    })();
</script>
</div>
{% endblock %}
