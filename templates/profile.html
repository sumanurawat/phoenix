{% extends "base.html" %}

{% block title %}@{{ username }} - Phoenix AI{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f8f9fa;
    }

    .profile-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .profile-header {
        background: white;
        border-radius: 16px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        text-align: center;
    }

    .profile-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 2.5rem;
        margin: 0 auto 1.5rem;
    }

    .profile-username {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .profile-handle {
        color: #7f8c8d;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .profile-bio {
        color: #555;
        line-height: 1.6;
        margin-bottom: 1.5rem;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .profile-stats {
        display: flex;
        gap: 2rem;
        justify-content: center;
        padding-top: 1rem;
        border-top: 1px solid #e0e0e0;
    }

    .stat {
        text-align: center;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #7f8c8d;
    }

    /* Instagram-style Tab Navigation */
    .profile-tabs {
        display: flex;
        justify-content: center;
        gap: 0;
        background: white;
        border-radius: 0;
        margin: 2rem 0 0 0;
        border-top: 1px solid #dbdbdb;
    }

    .profile-tab {
        flex: 1;
        max-width: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        background: none;
        border: none;
        border-top: 1px solid transparent;
        margin-top: -1px;
        color: #8e8e8e;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s;
    }

    .profile-tab i {
        font-size: 0.85rem;
    }

    .profile-tab:hover {
        color: #262626;
    }

    .profile-tab.active {
        color: #262626;
        border-top-color: #262626;
    }

    .tab-content-wrapper {
        margin-top: 1rem;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .gallery-header {
        background: white;
        border-radius: 16px;
        padding: 1.5rem 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .gallery-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
    }

    .gallery-count {
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .creations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .creation-item {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .creation-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .creation-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .creation-media-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 9/16;
        background: black;
        overflow: hidden;
    }

    .creation-media-wrapper video {
        background: black;
    }

    .creation-media-badge {
        position: absolute;
        bottom: 0.75rem;
        right: 0.75rem;
        background: rgba(0, 0, 0, 0.75);
        color: #fff;
        padding: 0.35rem 0.65rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        pointer-events: none;
        letter-spacing: 0.02em;
    }

    .creation-info {
        padding: 1rem;
    }

    .creation-caption {
        font-size: 0.95rem;
        color: #2c3e50;
        font-weight: 500;
        line-height: 1.4;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        line-clamp: 2;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .creation-prompt {
        font-size: 0.80rem;
        color: #7f8c8d;
        line-height: 1.3;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        line-clamp: 1;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .creation-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.85rem;
        color: #7f8c8d;
    }

    .creation-likes {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .creation-likes i {
        color: #e74c3c;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .empty-state-icon {
        font-size: 4rem;
        color: #bdc3c7;
        margin-bottom: 1rem;
    }

    .empty-state-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .empty-state-text {
        color: #7f8c8d;
        margin-bottom: 1.5rem;
    }

    .create-button {
        display: inline-block;
        padding: 0.75rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .create-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .loading-spinner {
        text-align: center;
        padding: 3rem 0;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 4px;
        border-color: #667eea;
        border-right-color: transparent;
    }

    .error-message {
        background: #fee;
        color: #c33;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
    }

    /* Modal styles */
    .creation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .creation-modal.show {
        display: flex;
    }

    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1000;
    }

    .modal-content-wrapper {
        position: relative;
        z-index: 1002;
        width: 90%;
        max-width: 1200px;
        height: 85vh;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 1003;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
    }

    .modal-close:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .modal-nav-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.35);
        color: white;
        border: none;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 1003;
        transition: background 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-nav-button:hover:not(:disabled) {
        background: rgba(0, 0, 0, 0.55);
    }

    .modal-nav-button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .modal-nav-prev {
        left: 1.5rem;
    }

    .modal-nav-next {
        right: 1.5rem;
    }

    .modal-two-pane {
        display: flex;
        height: 100%;
    }

    .modal-media-pane {
        flex: 0 0 65%;
        background: black;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-media-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-media-container img,
    .modal-media-container video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .modal-comments-pane {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
    }

    .comments-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
    }

    .creator-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .creator-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .creator-info {
        display: flex;
        flex-direction: column;
    }

    .creator-username-link {
        font-weight: 600;
        color: #2c3e50;
        text-decoration: none;
        font-size: 1rem;
    }

    .creator-username-link:hover {
        color: #5568d3;
    }

    .comments-meta {
        font-size: 0.85rem;
        color: #95a5a6;
    }

    .creation-caption-in-modal {
        font-size: 0.95rem;
        line-height: 1.5;
        color: #2c3e50;
    }

    .caption-username {
        font-weight: 600;
        margin-right: 0.5rem;
    }

    .caption-text {
        color: #2c3e50;
    }

    .modal-prompt {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #7f8c8d;
    }

    .modal-actions {
        padding: 1rem 1.5rem 0;
        border-top: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .modal-actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #2c3e50;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        padding: 0;
    }

    .modal-actions button.liked {
        color: #e74c3c;
    }

    .comments-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem 1.5rem;
    }

    .comment-item {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }

    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .comment-content {
        flex: 1;
    }

    .comment-username {
        font-weight: 600;
        font-size: 0.9rem;
        margin-right: 0.5rem;
        color: #2c3e50;
    }

    .comment-text {
        font-size: 0.9rem;
        color: #2c3e50;
        line-height: 1.4;
    }

    .comment-timestamp {
        font-size: 0.75rem;
        color: #95a5a6;
        margin-top: 0.25rem;
    }

    .comments-empty {
        text-align: center;
        color: #95a5a6;
        padding: 2rem;
    }

    .comment-input-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .comment-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 20px;
        font-size: 0.9rem;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s;
    }

    .comment-input:focus {
        border-color: #667eea;
    }

    .post-comment-btn {
        padding: 0.75rem 1.5rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s;
    }

    .post-comment-btn:hover {
        background: #5568d3;
    }

    .post-comment-btn:disabled {
        background: #b9c2ff;
        cursor: not-allowed;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e0e0e0;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Draft Details Container (separate from modal-media) */
    #draftDetails {
        max-width: 600px;
        width: 100%;
    }

    #draftDetails img.modal-media,
    #draftDetails video.modal-media {
        max-width: 100%;
        max-height: 60vh;
        object-fit: contain;
        margin-bottom: 1rem;
    }

    /* Drafts Cards (inside tab content) */
    .drafts-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }

    .draft-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }

    .draft-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateX(4px);
    }

    .draft-card.status-pending {
        border-left-color: #f39c12;
    }

    .draft-card.status-processing {
        border-left-color: #3498db;
    }

    .draft-card.status-draft {
        border-left-color: #27ae60;
    }

    .draft-card.status-failed {
        border-left-color: #e74c3c;
    }

    .draft-card.new-draft {
        position: relative;
        background: #fff8e7;
        border-left-color: #f39c12;
        box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.35);
        animation: pulse-highlight 2.2s ease-out 2;
    }

    .draft-card.new-draft::after {
        content: 'New';
        position: absolute;
        top: 12px;
        right: 16px;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        background: rgba(243, 156, 18, 0.15);
        color: #d35400;
    }

    @keyframes pulse-highlight {
        0% {
            box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.45);
        }
        60% {
            box-shadow: 0 0 0 16px rgba(243, 156, 18, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(243, 156, 18, 0);
        }
    }

    .draft-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .draft-status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: capitalize;
    }

    .draft-status-badge.pending {
        background: #fff3cd;
        color: #856404;
    }

    .draft-status-badge.processing {
        background: #cce5ff;
        color: #004085;
    }

    .draft-status-badge.draft {
        background: #d4edda;
        color: #155724;
    }

    .draft-status-badge.failed {
        background: #f8d7da;
        color: #721c24;
    }

    .draft-prompt {
        color: #2c3e50;
        font-size: 1rem;
        margin-bottom: 0.5rem;
        line-height: 1.5;
    }

    .draft-meta {
        color: #7f8c8d;
        font-size: 0.85rem;
    }

    .draft-actions {
        margin-top: 1rem;
        display: flex;
        gap: 0.75rem;
    }

    .draft-action-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .draft-action-btn.publish {
        background: #27ae60;
        color: white;
    }

    .draft-action-btn.publish:hover {
        background: #229954;
    }

    .draft-action-btn.delete {
        background: #e74c3c;
        color: white;
    }

    .draft-action-btn.delete:hover {
        background: #c0392b;
    }

    .draft-action-btn.view {
        background: #667eea;
        color: white;
    }

    .draft-action-btn.view:hover {
        background: #5568d3;
    }

    /* Shimmer loading animation for pending/processing drafts */
    @keyframes shimmer {
        0% {
            background-position: -468px 0;
        }
        100% {
            background-position: 468px 0;
        }
    }

    .shimmer {
        animation: shimmer 2s infinite linear;
        background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
        background-size: 800px 104px;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="profile-avatar-large" id="profileAvatar">?</div>
        <h1 class="profile-username" id="profileDisplayName">Loading...</h1>
        <div class="profile-handle" id="profileHandle">@...</div>
        <p class="profile-bio" id="profileBio"></p>

        <div class="profile-stats">
            <div class="stat">
                <div class="stat-number" id="statCreations">0</div>
                <div class="stat-label">Creations</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="statLikes">0</div>
                <div class="stat-label">Likes</div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation (Instagram-style) -->
    <div class="profile-tabs">
        <button class="profile-tab active" data-tab="posts" id="postsTab">
            <i class="bi bi-grid-3x3"></i>
            <span>Posts</span>
        </button>
        <button class="profile-tab" data-tab="drafts" id="draftsTab" style="display: none;">
            <i class="bi bi-folder2-open"></i>
            <span>Drafts</span>
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content-wrapper">
        <!-- Posts Tab -->
        <div id="postsContent" class="tab-content active">
            <!-- Loading State -->
            <div id="loadingSpinner" class="loading-spinner">
                <div class="spinner-border" role="status"></div>
                <p class="mt-3 text-muted">Loading creations...</p>
            </div>

            <!-- Error State -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <!-- Creations Grid -->
            <div id="creationsGrid" class="creations-grid" style="display: none;"></div>
        </div>

        <!-- Drafts Tab -->
        <div id="draftsContent" class="tab-content">
            <!-- Drafts Loading -->
            <div id="draftsLoadingSpinner" class="loading-spinner" style="display: none;">
                <div class="spinner-border" role="status"></div>
                <p class="mt-3 text-muted">Loading drafts...</p>
            </div>

            <!-- Drafts Grid (same style as posts) -->
            <div id="draftsGrid" class="creations-grid" style="display: none;"></div>

            <!-- Drafts Empty State -->
            <div id="draftsEmptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <i class="bi bi-folder2-open"></i>
                </div>
                <h3 class="empty-state-title">No drafts yet</h3>
                <p class="empty-state-text">Generated images and videos will appear here before publishing</p>
                <a href="/create" class="create-button">
                    <i class="fas fa-plus"></i> Create Your First Image
                </a>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">
            <i class="fas fa-image"></i>
        </div>
        <h3 class="empty-state-title">No creations yet</h3>
        <p class="empty-state-text" id="emptyStateText">This user hasn't shared any creations.</p>
        <a href="/create" class="create-button" id="createButtonLink" style="display: none;">
            <i class="fas fa-plus"></i> Create Your First Image
        </a>
    </div>
</div>

<!-- Modal for full-size view & draft editing -->
<div id="modalBackdrop" class="creation-modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-content-wrapper"></div>
</div>

<script>
    // Get username from URL path
    const pathParts = window.location.pathname.split('/');
    const username = pathParts[pathParts.length - 1];

    function buildProfileUrl(targetUsername) {
        const currentUrl = new URL(window.location.href);
        const tabParam = currentUrl.searchParams.get('tab');
        let destination = `/soho/${encodeURIComponent(targetUsername)}`;
        if (tabParam) {
            destination += `?tab=${encodeURIComponent(tabParam)}`;
        }
        return destination;
    }

    async function ensureCorrectProfileRoute() {
        if (username !== 'profile') {
            return false;
        }

        try {
            const cachedUsername = sessionStorage.getItem('phoenixCurrentUsername');
            if (cachedUsername && cachedUsername !== 'profile') {
                const destination = buildProfileUrl(cachedUsername);
                if (destination !== window.location.pathname + window.location.search) {
                    window.location.replace(destination);
                    return true;
                }
            }
        } catch (storageError) {
            console.warn('Unable to read cached username for profile redirect:', storageError);
        }

        try {
            const response = await fetch('/api/users/me', { cache: 'no-store' });
            const data = await response.json();

            if (response.ok && data.success && data.user?.username && data.user.username !== 'profile') {
                const destination = buildProfileUrl(data.user.username);
                if (destination !== window.location.pathname + window.location.search) {
                    window.location.replace(destination);
                    return true;
                }
            }
        } catch (error) {
            console.warn('Auto-correcting profile route failed:', error);
        }

        return false;
    }

    console.log('ðŸš€ Profile page JavaScript loaded! URL:', window.location.href);

    let userData = null;
    let creationsData = [];
    let currentModalIndex = -1;
    let draftsData = [];
    let isOwnProfile = false;
    let draftsListener = null;

    const MAX_DRAFT_REFRESH_ATTEMPTS = 4;
    const DRAFT_REFRESH_RETRY_DELAY_MS = 1200;
    let draftsLoadedAt = 0;
    let isLoadingDrafts = false;
    let highlightDraftId = null;
    let draftsRefreshRequested = false;
    let activeTab = 'posts';

    try {
        const storedRefreshFlag = sessionStorage.getItem('phoenixDraftsNeedsRefresh');
        const storedDraftId = sessionStorage.getItem('phoenixLastDraftId');
        if (storedRefreshFlag === 'true' && storedDraftId) {
            draftsRefreshRequested = true;
            highlightDraftId = storedDraftId;
            console.log('ðŸ†• Draft refresh requested. Target draft:', highlightDraftId);
        } else if (storedDraftId) {
            highlightDraftId = storedDraftId;
        }
    } catch (storageError) {
        console.warn('Unable to access draft refresh flags:', storageError);
    }

    // Load profile data
    async function loadProfile() {
        try {
            const response = await fetch(`/api/users/${username}`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'User not found');
            }

            userData = data.user;
            isOwnProfile = data.isOwnProfile || false;

            console.log('ðŸ” Profile Debug Info:');
            console.log('  - Username:', username);
            console.log('  - isOwnProfile:', isOwnProfile);
            console.log('  - User Data:', userData);

            // Update profile UI
            const avatarLetter = username[0].toUpperCase();
            document.getElementById('profileAvatar').textContent = avatarLetter;
            document.getElementById('profileDisplayName').textContent = userData.displayName || username;
            document.getElementById('profileHandle').textContent = `@${username}`;
            document.getElementById('profileBio').textContent = userData.bio || '';

            // Update page title
            document.title = `@${username} - Phoenix AI`;

            // Show/hide drafts tab based on ownership
            const draftsTab = document.getElementById('draftsTab');
            console.log('  - Drafts tab element:', draftsTab);
            
            if (isOwnProfile) {
                console.log('  âœ… This is YOUR profile - showing drafts tab');
                draftsTab.style.display = 'flex';
            } else {
                console.log('  âŒ Not your profile - hiding drafts tab');
                draftsTab.style.display = 'none';
            }

            // Load creations
            await loadCreations();

            // Load drafts if own profile
            if (isOwnProfile) {
                await loadDrafts();
                
                // Check if we should show drafts tab (e.g., from navigation link)
                const urlParams = new URLSearchParams(window.location.search);
                const requestedTab = urlParams.get('tab');
                console.log('  - URL tab parameter:', requestedTab);
                
                if (requestedTab === 'drafts') {
                    console.log('  ðŸ“‚ Switching to DRAFTS tab');
                    switchTab('drafts');
                } else {
                    console.log('  ðŸ“„ Switching to POSTS tab (default)');
                    switchTab('posts'); // Default to posts tab
                }
            } else {
                // Always show posts tab for other users
                console.log('  ðŸ“„ Not own profile - showing POSTS tab only');
                switchTab('posts');
            }

        } catch (error) {
            console.error('Error loading profile:', error);
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('errorMessage').textContent = error.message || 'Failed to load profile';
            document.getElementById('errorMessage').style.display = 'block';
        }
    }

    async function loadCreations() {
        try {
            const response = await fetch(`/api/users/${username}/creations?limit=50`);
            const data = await response.json();

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Failed to load creations');
            }

            creationsData = data.creations;

            // Update stats
            document.getElementById('statCreations').textContent = creationsData.length;

            const totalLikes = creationsData.reduce((sum, c) => sum + (c.likeCount || 0), 0);
            document.getElementById('statLikes').textContent = totalLikes;

            // Update gallery count (optional element)
            const galleryCountEl = document.getElementById('galleryCount');
            if (galleryCountEl) {
                galleryCountEl.textContent =
                    `${creationsData.length} ${creationsData.length === 1 ? 'creation' : 'creations'}`;
            }

            // Hide loading
            document.getElementById('loadingSpinner').style.display = 'none';

            // Show grid or empty state
            if (creationsData.length > 0) {
                renderCreations();
                document.getElementById('creationsGrid').style.display = 'grid';
            } else {
                showEmptyState();
            }

        } catch (error) {
            console.error('Error loading creations:', error);
            document.getElementById('loadingSpinner').style.display = 'none';
            showEmptyState();
        }
    }

    function renderCreations() {
        const grid = document.getElementById('creationsGrid');
        grid.innerHTML = '';

        creationsData.forEach((creation, index) => {
            const item = document.createElement('div');
            item.className = 'creation-item';
            item.onclick = () => openModal(index);

            const timeAgo = creation.publishedAt ? formatTimeAgo(new Date(creation.publishedAt)) : '';
            
            // Determine what text to display: caption if available, otherwise prompt
            const displayText = creation.caption && creation.caption.trim() !== '' 
                ? creation.caption 
                : creation.prompt;

            const isVideo = creation.mediaType === 'video';
            const posterUrl = creation.thumbnailUrl || '';
            const mediaContent = isVideo
                ? `
                    <video
                        src="${creation.mediaUrl}"
                        ${posterUrl ? `poster="${posterUrl}"` : ''}
                        class="creation-thumbnail"
                        muted
                        preload="metadata"
                        playsinline
                    ></video>`
                : `
                    <img
                        src="${creation.mediaUrl}"
                        alt="${escapeHtml(displayText)}"
                        class="creation-thumbnail"
                    >`;

            const badgeHTML = isVideo
                ? `<div class="creation-media-badge"><i class="fas fa-play"></i><span>Video</span></div>`
                : '';

            item.innerHTML = `
                <div class="creation-media-wrapper${isVideo ? ' is-video' : ''}">
                    ${mediaContent}
                    ${badgeHTML}
                </div>
                <div class="creation-info">
                    ${creation.caption && creation.caption.trim() !== '' 
                        ? `<div class="creation-caption">${escapeHtml(creation.caption)}</div>`
                        : `<div class="creation-caption" style="color: #7f8c8d; font-style: italic;">No caption</div>`
                    }
                    <div class="creation-prompt" style="display: flex; align-items: center; gap: 0.25rem;">
                        <i class="fas fa-lightbulb" style="font-size: 0.7rem;"></i>
                        <span>${escapeHtml(creation.prompt)}</span>
                    </div>
                    <div class="creation-meta">
                        <span>${timeAgo}</span>
                        <span class="creation-likes">
                            <i class="fas fa-heart"></i>
                            ${creation.likeCount || 0}
                        </span>
                    </div>
                </div>
            `;

            grid.appendChild(item);
        });
    }

    function showEmptyState() {
        const emptyState = document.getElementById('emptyState');
        const emptyStateText = document.getElementById('emptyStateText');
        const createButton = document.getElementById('createButtonLink');

        if (isOwnProfile) {
            emptyStateText.textContent = "You haven't created anything yet. Start creating!";
            createButton.style.display = 'inline-block';
        } else {
            emptyStateText.textContent = "This user hasn't shared any creations.";
            createButton.style.display = 'none';
        }

        emptyState.style.display = 'block';
    }

    function openModal(creationIndex) {
        if (!Array.isArray(creationsData) || creationsData.length === 0) {
            return;
        }

        if (typeof creationIndex !== 'number' || creationIndex < 0 || creationIndex >= creationsData.length) {
            return;
        }

        currentModalIndex = creationIndex;

        const backdrop = document.getElementById('modalBackdrop');
        if (!backdrop) {
            return;
        }

        backdrop.style.display = 'flex';
        backdrop.classList.add('show');
        document.body.style.overflow = 'hidden';

        renderModalForCurrentCreation();
    }

    function renderModalForCurrentCreation() {
        if (currentModalIndex < 0 || currentModalIndex >= creationsData.length) {
            return;
        }

        const creation = creationsData[currentModalIndex];
        if (!creation) {
            return;
        }

        const backdrop = document.getElementById('modalBackdrop');
        const modalContent = backdrop.querySelector('.modal-content-wrapper');

        if (!modalContent) {
            return;
        }

        // Pause any currently playing videos before swapping content
        modalContent.querySelectorAll('video').forEach(video => {
            try {
                video.pause();
            } catch (err) {
                console.debug('Unable to pause video before render:', err);
            }
        });

        const creationUsername = creation.username || username || '';
        const avatarLetter = creationUsername ? creationUsername.charAt(0).toUpperCase() : '?';
        const displayText = creation.caption && creation.caption.trim() !== ''
            ? creation.caption
            : creation.prompt;
        const timeAgo = creation.publishedAt ? formatTimeAgo(new Date(creation.publishedAt)) : '';

        let mediaHTML = '';
        if (creation.mediaType === 'image') {
            mediaHTML = `<img src="${creation.mediaUrl}" alt="${escapeHtml(displayText)}">`;
        } else if (creation.mediaType === 'video') {
            mediaHTML = `<video src="${creation.mediaUrl}" controls loop playsinline>
                <source src="${creation.mediaUrl}" type="video/mp4">
                Your browser does not support the video tag.
            </video>`;
        }

        const captionHTML = creation.caption && creation.caption.trim() !== ''
            ? `<div class="creation-caption-in-modal"><span class="caption-username">@${creationUsername}</span><span class="caption-text">${escapeHtml(creation.caption)}</span></div>`
            : '';

        const hasPrevious = currentModalIndex > 0;
        const hasNext = currentModalIndex < creationsData.length - 1;

        modalContent.innerHTML = `
            <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
            <button class="modal-nav-button modal-nav-prev" onclick="showPreviousCreation()" ${hasPrevious ? '' : 'disabled'} aria-label="Previous creation">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="modal-nav-button modal-nav-next" onclick="showNextCreation()" ${hasNext ? '' : 'disabled'} aria-label="Next creation">
                <i class="fas fa-chevron-right"></i>
            </button>

            <div class="modal-two-pane">
                <div class="modal-media-pane">
                    <div class="modal-media-container">
                        ${mediaHTML}
                    </div>
                </div>

                <div class="modal-comments-pane">
                    <div class="comments-header">
                        <div class="creator-row">
                            <div class="creator-avatar">${avatarLetter}</div>
                            <div class="creator-info">
                                <a href="/users/${creationUsername}" class="creator-username-link">@${creationUsername}</a>
                                <span class="comments-meta">${timeAgo}</span>
                            </div>
                        </div>
                        ${captionHTML}
                        <div class="modal-prompt">
                            <i class="fas fa-lightbulb"></i>
                            <span>${escapeHtml(creation.prompt)}</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="modal-like-button ${creation.isLiked ? 'liked' : ''}" onclick="toggleLike('${creation.creationId}', this)" data-like-button="${creation.creationId}">
                            <i class="fas fa-heart"></i>
                            <span>${creation.likeCount || 0}</span>
                        </button>
                        <button class="modal-comment-button" onclick="focusCommentInput('${creation.creationId}')" data-comment-button="${creation.creationId}">
                            <i class="far fa-comment"></i>
                            <span>${creation.commentCount || 0}</span>
                        </button>
                    </div>

                    <div class="comments-list" id="commentsContainer-${creation.creationId}">
                        <div class="comments-empty">
                            <i class="far fa-comments" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                            No comments yet. Be the first to comment!
                        </div>
                    </div>

                    <div class="comment-input-footer">
                        <input
                            type="text"
                            id="commentInput-${creation.creationId}"
                            class="comment-input"
                            placeholder="Add a comment..."
                            onkeypress="if(event.key==='Enter') postComment('${creation.creationId}')"
                        >
                        <button class="post-comment-btn" data-comment-submit="${creation.creationId}" onclick="postComment('${creation.creationId}')">
                            Post
                        </button>
                    </div>
                </div>
            </div>
        `;

        loadComments(creation.creationId);
    }

    function showPreviousCreation() {
        if (currentModalIndex <= 0) {
            return;
        }
        currentModalIndex -= 1;
        renderModalForCurrentCreation();
    }

    function showNextCreation() {
        if (currentModalIndex < 0 || currentModalIndex >= creationsData.length - 1) {
            return;
        }
        currentModalIndex += 1;
        renderModalForCurrentCreation();
    }

    // Load comments for a creation
    async function loadComments(creationId) {
        const container = document.getElementById(`commentsContainer-${creationId}`);
        if (!container) return;

        try {
            const response = await fetch(`/api/creations/${creationId}/comments`);
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to load comments');
            }

            if (!data.comments || data.comments.length === 0) {
                container.innerHTML = `
                    <div class="comments-empty">
                        <i class="far fa-comments" style="font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>
                        No comments yet. Be the first to comment!
                    </div>
                `;
                return;
            }

            container.innerHTML = data.comments.map(comment => {
                const commentTime = formatTimeAgo(new Date(comment.createdAt));
                const avatarLetter = comment.username ? comment.username[0].toUpperCase() : '?';

                return `
                    <div class="comment-item">
                        <div class="comment-avatar">${avatarLetter}</div>
                        <div class="comment-content">
                            <div>
                                <span class="comment-username">@${comment.username}</span>
                                <span class="comment-text">${escapeHtml(comment.commentText)}</span>
                            </div>
                            <div class="comment-timestamp">${commentTime}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading comments:', error);
            container.innerHTML = `
                <div class="comments-empty">
                    Unable to load comments right now.
                </div>
            `;
        }
    }

    function focusCommentInput(creationId) {
        const input = document.getElementById(`commentInput-${creationId}`);
        if (input) {
            input.focus();
        }
    }

    // Post a comment
    window.postComment = async function(creationId) {
        const modal = document.getElementById('modalBackdrop');
        const input = modal.querySelector(`#commentInput-${creationId}`);
        const submitButton = modal.querySelector(`button[data-comment-submit="${creationId}"]`);
        const commentButton = modal.querySelector(`button[data-comment-button="${creationId}"]`);

        if (!input) return;

        const commentText = input.value.trim();
        if (!commentText) return;

        if (submitButton) {
            submitButton.disabled = true;
        }

        try {
            const response = await fetch(`/api/creations/${creationId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ commentText })
            });

            const data = await response.json();

            if (!data.success) {
                alert(data.error || 'Failed to post comment');
                return;
            }

            input.value = '';
            await loadComments(creationId);

            if (commentButton) {
                const countSpan = commentButton.querySelector('span');
                if (countSpan) {
                    const currentCount = parseInt(countSpan.textContent) || 0;
                    countSpan.textContent = currentCount + 1;
                }
            }

            const creation = creationsData.find(c => c.creationId === creationId);
            if (creation) {
                creation.commentCount = (creation.commentCount || 0) + 1;
            }
        } catch (error) {
            console.error('Error posting comment:', error);
            alert('Failed to post comment. Please try again.');
        } finally {
            if (submitButton) {
                submitButton.disabled = false;
            }
        }
    };

    // Toggle like function for modal
    window.toggleLike = async function(creationId, button) {
        const isCurrentlyLiked = button.classList.contains('liked');
        const likeCountEl = button.querySelector('span');
        const currentCount = parseInt(likeCountEl.textContent);

        // Optimistic update
    button.classList.toggle('liked');
        likeCountEl.textContent = isCurrentlyLiked ? currentCount - 1 : currentCount + 1;

        try {
            const url = `/api/creations/${creationId}/like`;
            const method = isCurrentlyLiked ? 'DELETE' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                // Update with actual count from server
                likeCountEl.textContent = data.likeCount;
                
                // Update the creation in our data array
                const creation = creationsData.find(c => c.creationId === creationId);
                if (creation) {
                    creation.likeCount = data.likeCount;
                    creation.isLiked = !isCurrentlyLiked;
                }
            } else {
                // Revert on error
                button.classList.toggle('liked');
                likeCountEl.textContent = currentCount;
                console.error('Failed to toggle like:', data.error);
            }
        } catch (error) {
            // Revert on error
            button.classList.toggle('liked');
            likeCountEl.textContent = currentCount;
            console.error('Error toggling like:', error);
        }
    };

    function closeModal() {
        const backdrop = document.getElementById('modalBackdrop');
        backdrop.classList.remove('show');
        backdrop.style.display = 'none';
        document.body.style.overflow = '';

        // Pause any playing videos
        const videos = backdrop.querySelectorAll('video');
        videos.forEach(video => {
            video.pause();
            video.src = '';
        });

        const modalContent = backdrop.querySelector('.modal-content-wrapper');
        if (modalContent) {
            modalContent.innerHTML = '';
        }

        // Clear draft data
        currentDraftData = null;
        currentModalIndex = -1;
    }

    // Close modal on backdrop click
    document.getElementById('modalBackdrop').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-backdrop')) {
            closeModal();
        }
    });

    // Escape key to close modal
    document.addEventListener('keydown', (e) => {
        const backdrop = document.getElementById('modalBackdrop');
        const isModalOpen = backdrop && backdrop.classList.contains('show');

        if (e.key === 'Escape') {
            if (isModalOpen) {
                closeModal();
            }
            return;
        }

        if (!isModalOpen || currentModalIndex < 0) {
            return;
        }

        if (e.key === 'ArrowRight') {
            e.preventDefault();
            showNextCreation();
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            showPreviousCreation();
        }
    });

    function formatTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);

        const intervals = [
            { label: 'year', seconds: 31536000 },
            { label: 'month', seconds: 2592000 },
            { label: 'week', seconds: 604800 },
            { label: 'day', seconds: 86400 },
            { label: 'hour', seconds: 3600 },
            { label: 'minute', seconds: 60 },
        ];

        for (const interval of intervals) {
            const count = Math.floor(seconds / interval.seconds);
            if (count >= 1) {
                return `${count} ${interval.label}${count !== 1 ? 's' : ''} ago`;
            }
        }

        return 'Just now';
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    async function loadDrafts(options = {}) {
        const {
            force = false,
            attempt = 1,
            reason = 'initial'
        } = options;

        console.log('ðŸ“‹ loadDrafts() called with options:', { force, attempt, reason, isOwnProfile, isLoadingDrafts });

        if (isLoadingDrafts && !force) {
            console.log('â³ Draft load already in progress; skipping duplicate request.');
            return;
        }

        if (force) {
            console.log(`ðŸ” Forcing drafts reload (attempt ${attempt}, reason: ${reason})`);
        }

        isLoadingDrafts = true;

        try {
            console.log('ðŸŒ Fetching drafts from /api/generate/drafts...');
            const response = await fetch('/api/generate/drafts?limit=50', {
                cache: 'no-store'
            });
            const data = await response.json();
            console.log('âœ… Drafts response:', { ok: response.ok, status: response.status, count: data.creations?.length || 0, data });

            if (!response.ok || !data.success) {
                console.error('Failed to load drafts:', data.error);
                return;
            }

            draftsData = data.creations || [];
            draftsLoadedAt = Date.now();

            const highlightId = highlightDraftId && draftsData.some(draft => draft.id === highlightDraftId)
                ? highlightDraftId
                : null;

            if (draftsData.length > 0) {
                renderDrafts({ highlightDraftId: highlightId });
            } else {
                document.getElementById('draftsContainer').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6c757d;">
                        <i class="bi bi-folder2-open" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem; font-size: 1.1rem;">No drafts yet</p>
                        <p style="font-size: 0.9rem;">Generated images and videos will appear here before publishing</p>
                    </div>
                `;
            }

            if (highlightId) {
                console.log('âœ… Newly generated draft located. Highlighting card:', highlightId);
                draftsRefreshRequested = false;
                highlightDraftId = null;
                try {
                    sessionStorage.removeItem('phoenixDraftsNeedsRefresh');
                    sessionStorage.removeItem('phoenixLastDraftId');
                } catch (storageError) {
                    console.warn('Unable to clear draft refresh flags:', storageError);
                }
            } else if (draftsRefreshRequested && attempt < MAX_DRAFT_REFRESH_ATTEMPTS) {
                const nextAttempt = attempt + 1;
                const retryDelay = DRAFT_REFRESH_RETRY_DELAY_MS * attempt;
                console.log(`â±ï¸ Draft not found yet (attempt ${attempt}). Retrying in ${retryDelay}ms...`);
                setTimeout(() => {
                    loadDrafts({
                        force: true,
                        attempt: nextAttempt,
                        reason: 'pending-new-draft'
                    });
                }, retryDelay);
            } else if (draftsRefreshRequested) {
                console.warn('âš ï¸ Draft refresh requested but not located after retries.');
                draftsRefreshRequested = false;
                try {
                    sessionStorage.removeItem('phoenixDraftsNeedsRefresh');
                } catch (storageError) {
                    console.warn('Unable to clear draft refresh flag:', storageError);
                }
            }

        } catch (error) {
            console.error('Error loading drafts:', error);
        } finally {
            isLoadingDrafts = false;
        }
    }

    function renderDrafts(options = {}) {
        const { highlightDraftId = null } = options;
        const grid = document.getElementById('draftsGrid');
        const emptyState = document.getElementById('draftsEmptyState');
        
        grid.innerHTML = '';

        if (draftsData.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'flex';
            return;
        }

        emptyState.style.display = 'none';
        grid.style.display = 'grid';

        let highlightedCard = null;

        draftsData.forEach(draft => {
            const item = document.createElement('div');
            item.className = 'creation-item';
            item.style.position = 'relative';
            item.style.cursor = 'pointer';
            
            if (highlightDraftId && draft.id === highlightDraftId) {
                item.style.animation = 'pulse 2s ease-in-out 3';
                highlightedCard = item;
            }

            // Determine media type and thumbnail
            const mediaType = draft.mediaType || 'unknown';
            const mediaIcon = mediaType === 'image' ? 'ðŸ–¼ï¸' : mediaType === 'video' ? 'ðŸŽ¬' : 'ðŸ“„';
            
            let thumbnailContent = '';
            
            if (draft.status === 'pending' || draft.status === 'processing') {
                // Loading state with shimmer
                thumbnailContent = `
                    <div style="width: 100%; aspect-ratio: 9/16; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; display: flex; align-items: center; justify-content: center; color: #999;">
                        <div style="text-align: center;">
                            <div class="spinner-border" style="width: 2.5rem; height: 2.5rem;"></div>
                            <div style="margin-top: 0.75rem; font-size: 0.85rem;">${draft.status === 'processing' ? 'Processing...' : 'Pending...'}</div>
                        </div>
                    </div>
                `;
            } else if (draft.status === 'draft' && draft.mediaUrl) {
                // Show media thumbnail
                if (mediaType === 'image') {
                    thumbnailContent = `<img src="${draft.mediaUrl}" alt="${escapeHtml(draft.prompt)}" class="creation-thumbnail">`;
                } else if (mediaType === 'video') {
                    const posterUrl = draft.thumbnailUrl || draft.mediaUrl;
                    thumbnailContent = `
                        <div style="position: relative; width: 100%; aspect-ratio: 9/16;">
                            <video src="${draft.mediaUrl}" poster="${posterUrl}" class="creation-thumbnail" style="object-fit: cover;"></video>
                            <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                <i class="bi bi-play-fill"></i> ${draft.duration || 8}s
                            </div>
                        </div>
                    `;
                }
            } else if (draft.status === 'failed') {
                // Error state
                thumbnailContent = `
                    <div style="width: 100%; aspect-ratio: 9/16; background: linear-gradient(135deg, #fee 0%, #fdd 100%); display: flex; align-items: center; justify-content: center; color: #c33;">
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">âŒ</div>
                            <div style="font-weight: 600; font-size: 0.9rem;">Generation Failed</div>
                        </div>
                    </div>
                `;
            }

            // Status overlay badge
            let statusBadge = '';
            if (draft.status === 'pending') {
                statusBadge = `<div style="position: absolute; top: 8px; left: 8px; background: rgba(255,193,7,0.95); color: #000; padding: 0.35rem 0.65rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.35rem;"><span>â³</span> Pending</div>`;
            } else if (draft.status === 'processing') {
                statusBadge = `<div style="position: absolute; top: 8px; left: 8px; background: rgba(33,150,243,0.95); color: white; padding: 0.35rem 0.65rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.35rem;"><span>âš™ï¸</span> Processing</div>`;
            } else if (draft.status === 'draft') {
                statusBadge = `<div style="position: absolute; top: 8px; left: 8px; background: rgba(76,175,80,0.95); color: white; padding: 0.35rem 0.65rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.35rem;"><span>âœ…</span> Ready</div>`;
            } else if (draft.status === 'failed') {
                statusBadge = `<div style="position: absolute; top: 8px; left: 8px; background: rgba(244,67,54,0.95); color: white; padding: 0.35rem 0.65rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.35rem;"><span>âŒ</span> Failed</div>`;
            }

            item.innerHTML = `
                ${thumbnailContent}
                ${statusBadge}
            `;

            item.addEventListener('click', () => openDraftModal(draft));
            grid.appendChild(item);
        });

        if (highlightedCard) {
            requestAnimationFrame(() => {
                highlightedCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }
    }

    // Open draft in modal with editing capabilities
    let currentDraftData = null;

    window.openDraftModal = function(draft) {
        currentDraftData = draft;
        const modal = document.getElementById('modalBackdrop');
        const modalContent = modal.querySelector('.modal-content-wrapper');

        modalContent.innerHTML = `
            <button class="modal-close" onclick="closeModal()">Ã—</button>
            <div class="modal-draft-wrapper" style="width: min(640px, 90vw); max-height: 85vh; overflow-y: auto; background: white; border-radius: 12px; padding: 2rem;">
                <div id="draftDetails" style="display: block; width: 100%;">
                    <div id="draftMediaPreview" style="margin-bottom: 1.5rem; text-align: center;"></div>
                    <div id="draftStatusContainer" style="margin-bottom: 1rem;"></div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">Prompt</label>
                        <div id="draftPrompt" style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px; color: #555;"></div>
                    </div>
                    <div id="captionEditor" style="display: none; margin-bottom: 1.5rem;">
                        <label for="draftCaption" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">Caption (Optional)</label>
                        <textarea id="draftCaption" 
                                  rows="3" 
                                  style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                                  placeholder="Add a caption for your creation..."></textarea>
                    </div>
                    <div id="draftMeta" style="display: flex; gap: 1rem; font-size: 0.9rem; color: #666; margin-bottom: 1.5rem; flex-wrap: wrap;"></div>
                    <div id="draftError" style="display: none; background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 1rem; color: #c33; margin-bottom: 1.5rem;"></div>
                    <div id="draftActions" style="display: flex; gap: 0.75rem; flex-wrap: wrap;"></div>
                </div>
            </div>
        `;

        const draftMediaPreview = document.getElementById('draftMediaPreview');

        // Populate status
        const statusContainer = document.getElementById('draftStatusContainer');
        const mediaType = draft.mediaType || 'unknown';
        const mediaIcon = mediaType === 'image' ? 'ðŸ–¼ï¸' : mediaType === 'video' ? 'ðŸŽ¬' : 'ðŸ“„';
        
        let statusHTML = '';
        if (draft.status === 'pending') {
            statusHTML = `<div style="background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;"><span style="font-size: 1.5rem;">â³</span> Pending - Waiting to generate</div>`;
        } else if (draft.status === 'processing') {
            statusHTML = `<div style="background: #d1ecf1; border: 1px solid #17a2b8; color: #0c5460; padding: 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;"><div class="spinner-border spinner-border-sm"></div> Processing - Generating ${mediaType}...</div>`;
        } else if (draft.status === 'draft') {
            statusHTML = `<div style="background: #d4edda; border: 1px solid #28a745; color: #155724; padding: 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;"><span style="font-size: 1.5rem;">âœ…</span> Ready to publish!</div>`;
        } else if (draft.status === 'failed') {
            statusHTML = `<div style="background: #f8d7da; border: 1px solid #dc3545; color: #721c24; padding: 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;"><span style="font-size: 1.5rem;">âŒ</span> Generation failed</div>`;
        }
        statusContainer.innerHTML = statusHTML;

        // Media preview (render inside draft details)
        if (draft.status === 'draft' && draft.mediaUrl) {
            if (mediaType === 'image') {
                draftMediaPreview.innerHTML = `<img src="${draft.mediaUrl}" alt="${escapeHtml(draft.prompt)}" style="max-width: 100%; max-height: 60vh; border-radius: 8px; object-fit: contain;">`;
            } else if (mediaType === 'video') {
                const posterAttr = draft.thumbnailUrl ? `poster="${draft.thumbnailUrl}"` : '';
                draftMediaPreview.innerHTML = `<video src="${draft.mediaUrl}" ${posterAttr} controls style="max-width: 100%; max-height: 60vh; border-radius: 8px;"></video>`;
            }
        }

        // Populate prompt
        document.getElementById('draftPrompt').textContent = draft.prompt;

        // Show/hide caption editor
        const captionEditor = document.getElementById('captionEditor');
        const draftCaption = document.getElementById('draftCaption');
        if (draft.status === 'draft') {
            captionEditor.style.display = 'block';
            draftCaption.value = draft.caption || '';
        } else {
            captionEditor.style.display = 'none';
        }

        // Metadata
        const timeAgo = draft.createdAt ? formatTimeAgo(new Date(draft.createdAt)) : 'Just now';
        const metaParts = [
            `${mediaIcon} ${mediaType}`,
            timeAgo,
            draft.aspectRatio || null,
            draft.duration ? `${draft.duration}s` : null
        ].filter(Boolean);
        document.getElementById('draftMeta').innerHTML = metaParts.map(part => `<span>${part}</span>`).join('<span> â€¢ </span>');

        // Error message
        const errorEl = document.getElementById('draftError');
        if (draft.status === 'failed' && draft.error) {
            errorEl.style.display = 'block';
            errorEl.innerHTML = `<strong>Error:</strong> ${escapeHtml(draft.error)}`;
        } else {
            errorEl.style.display = 'none';
        }

        // Actions
        const actionsContainer = document.getElementById('draftActions');
        actionsContainer.innerHTML = '';

        if (draft.status === 'draft') {
            const publishBtn = document.createElement('button');
            publishBtn.className = 'btn btn-primary';
            publishBtn.innerHTML = '<i class="bi bi-upload"></i> Publish';
            publishBtn.style.cssText = 'flex: 1; padding: 0.75rem; font-weight: 600;';
            publishBtn.onclick = () => publishDraftFromModal(draft.id);
            actionsContainer.appendChild(publishBtn);
        }

        if (draft.status === 'pending' || draft.status === 'processing') {
            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'btn btn-secondary';
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh';
            refreshBtn.style.cssText = 'flex: 1; padding: 0.75rem; font-weight: 600;';
            refreshBtn.onclick = () => window.location.reload();
            actionsContainer.appendChild(refreshBtn);
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-outline-danger';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete';
        deleteBtn.style.cssText = 'padding: 0.75rem 1.5rem; font-weight: 600;';
        deleteBtn.onclick = () => deleteDraftFromModal(draft.id);
        actionsContainer.appendChild(deleteBtn);

        // Show modal
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    };

    window.publishDraftFromModal = async function(draftId) {
        const caption = document.getElementById('draftCaption').value.trim();

        try {
            const response = await fetch(`/api/generate/creation/${draftId}/publish`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ caption: caption || '' })
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                alert('Failed to publish: ' + (data.error || 'Unknown error'));
                return;
            }

            alert('âœ… Published successfully!');
            closeModal();
            window.location.reload();

        } catch (error) {
            console.error('Error publishing draft:', error);
            alert('Failed to publish. Please try again.');
        }
    };

    window.deleteDraftFromModal = async function(draftId) {
        if (!confirm('Are you sure you want to delete this draft? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/generate/creation/${draftId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                alert('Failed to delete: ' + (data.error || 'Unknown error'));
                return;
            }

            alert('âœ… Draft deleted successfully!');
            closeModal();
            window.location.reload();

        } catch (error) {
            console.error('Error deleting draft:', error);
            alert('Failed to delete. Please try again.');
        }
    };

    window.publishDraft = async function(draftId) {
        const caption = prompt('Add a caption for your creation (optional):');
        if (caption === null) return; // User cancelled

        try {
            const response = await fetch(`/api/generate/creation/${draftId}/publish`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ caption: caption || '' })
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                alert('Failed to publish: ' + (data.error || 'Unknown error'));
                return;
            }

            alert('âœ… Published successfully! Refreshing...');
            window.location.reload();

        } catch (error) {
            console.error('Error publishing draft:', error);
            alert('Failed to publish. Please try again.');
        }
    };

    window.deleteDraft = async function(draftId) {
        if (!confirm('Are you sure you want to delete this draft? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/generate/creation/${draftId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok || !data.success) {
                alert('Failed to delete: ' + (data.error || 'Unknown error'));
                return;
            }

            alert('âœ… Draft deleted successfully!');
            window.location.reload();

        } catch (error) {
            console.error('Error deleting draft:', error);
            alert('Failed to delete. Please try again.');
        }
    };

    // Tab switching functionality
    function switchTab(tabName) {
        console.log('ðŸ”„ Switching to tab:', tabName);
        
        // Update tab buttons
        document.querySelectorAll('.profile-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
        console.log('  - Target tab button:', targetTab);
        targetTab?.classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        const targetContent = document.getElementById(`${tabName}Content`);
        console.log('  - Target content:', targetContent);
        targetContent?.classList.add('active');

        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.pushState({}, '', url);
        console.log('  - New URL:', url.href);

        activeTab = tabName;

        if (tabName === 'drafts' && isOwnProfile) {
            const now = Date.now();
            const isStale = !draftsLoadedAt || (now - draftsLoadedAt > 10000);
            const reason = draftsRefreshRequested ? 'session-refresh' : 'tab-switch';
            const awaitingHighlight = highlightDraftId && !draftsData.some(draft => draft.id === highlightDraftId);

            if (draftsRefreshRequested || isStale || awaitingHighlight) {
                loadDrafts({
                    force: true,
                    attempt: 1,
                    reason: awaitingHighlight ? 'awaiting-highlight' : reason
                });
            }
        }
    }

    // Add click listeners to tabs
    document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            switchTab(tab.dataset.tab);
        });
    });

    // Load on page load (auto-correct legacy /soho/profile redirects)
    (async () => {
        const corrected = await ensureCorrectProfileRoute();
        if (!corrected) {
            loadProfile();
        }
    })();
</script>
{% endblock %}
